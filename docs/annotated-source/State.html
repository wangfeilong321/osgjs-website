<!DOCTYPE html>

<html>
<head>
  <title>State.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="OSG.html">
                OSG.js
              </a>
            
              
              <a class="source" href="BillboardAttribute.html">
                BillboardAttribute.js
              </a>
            
              
              <a class="source" href="BlendColor.html">
                BlendColor.js
              </a>
            
              
              <a class="source" href="BlendFunc.html">
                BlendFunc.js
              </a>
            
              
              <a class="source" href="BoundingBox.html">
                BoundingBox.js
              </a>
            
              
              <a class="source" href="BoundingSphere.html">
                BoundingSphere.js
              </a>
            
              
              <a class="source" href="BufferArray.html">
                BufferArray.js
              </a>
            
              
              <a class="source" href="BufferArrayProxy.html">
                BufferArrayProxy.js
              </a>
            
              
              <a class="source" href="Camera.html">
                Camera.js
              </a>
            
              
              <a class="source" href="ColorMask.html">
                ColorMask.js
              </a>
            
              
              <a class="source" href="ComputeBoundsVisitor.html">
                ComputeBoundsVisitor.js
              </a>
            
              
              <a class="source" href="ComputeMatrixFromNodePath.html">
                ComputeMatrixFromNodePath.js
              </a>
            
              
              <a class="source" href="CullFace.html">
                CullFace.js
              </a>
            
              
              <a class="source" href="CullSettings.html">
                CullSettings.js
              </a>
            
              
              <a class="source" href="CullStack.html">
                CullStack.js
              </a>
            
              
              <a class="source" href="CullVisitor.html">
                CullVisitor.js
              </a>
            
              
              <a class="source" href="CullingSet.html">
                CullingSet.js
              </a>
            
              
              <a class="source" href="Depth.html">
                Depth.js
              </a>
            
              
              <a class="source" href="DrawArrayLengths.html">
                DrawArrayLengths.js
              </a>
            
              
              <a class="source" href="DrawArrays.html">
                DrawArrays.js
              </a>
            
              
              <a class="source" href="DrawElements.html">
                DrawElements.js
              </a>
            
              
              <a class="source" href="EllipsoidModel.html">
                EllipsoidModel.js
              </a>
            
              
              <a class="source" href="FrameBufferObject.html">
                FrameBufferObject.js
              </a>
            
              
              <a class="source" href="FrameStamp.html">
                FrameStamp.js
              </a>
            
              
              <a class="source" href="GLObject.html">
                GLObject.js
              </a>
            
              
              <a class="source" href="Geometry.html">
                Geometry.js
              </a>
            
              
              <a class="source" href="Image.html">
                Image.js
              </a>
            
              
              <a class="source" href="ImageStream.html">
                ImageStream.js
              </a>
            
              
              <a class="source" href="KdTree.html">
                KdTree.js
              </a>
            
              
              <a class="source" href="KdTreeBuilder.html">
                KdTreeBuilder.js
              </a>
            
              
              <a class="source" href="KdTreeRayIntersector.html">
                KdTreeRayIntersector.js
              </a>
            
              
              <a class="source" href="KdTreeSphereIntersector.html">
                KdTreeSphereIntersector.js
              </a>
            
              
              <a class="source" href="Light.html">
                Light.js
              </a>
            
              
              <a class="source" href="LightSource.html">
                LightSource.js
              </a>
            
              
              <a class="source" href="LineWidth.html">
                LineWidth.js
              </a>
            
              
              <a class="source" href="Lod.html">
                Lod.js
              </a>
            
              
              <a class="source" href="Map.html">
                Map.js
              </a>
            
              
              <a class="source" href="Material.html">
                Material.js
              </a>
            
              
              <a class="source" href="Math.html">
                Math.js
              </a>
            
              
              <a class="source" href="Matrix.html">
                Matrix.js
              </a>
            
              
              <a class="source" href="MatrixMemoryPool.html">
                MatrixMemoryPool.js
              </a>
            
              
              <a class="source" href="MatrixTransform.html">
                MatrixTransform.js
              </a>
            
              
              <a class="source" href="Node.html">
                Node.js
              </a>
            
              
              <a class="source" href="NodeVisitor.html">
                NodeVisitor.js
              </a>
            
              
              <a class="source" href="Notify.html">
                Notify.js
              </a>
            
              
              <a class="source" href="Object.html">
                Object.js
              </a>
            
              
              <a class="source" href="Options.html">
                Options.js
              </a>
            
              
              <a class="source" href="PagedLOD.html">
                PagedLOD.js
              </a>
            
              
              <a class="source" href="Plane.html">
                Plane.js
              </a>
            
              
              <a class="source" href="Polytope.html">
                Polytope.js
              </a>
            
              
              <a class="source" href="PrimitiveFunctor.html">
                PrimitiveFunctor.js
              </a>
            
              
              <a class="source" href="PrimitiveSet.html">
                PrimitiveSet.js
              </a>
            
              
              <a class="source" href="Program.html">
                Program.js
              </a>
            
              
              <a class="source" href="Projection.html">
                Projection.js
              </a>
            
              
              <a class="source" href="Quat.html">
                Quat.js
              </a>
            
              
              <a class="source" href="RenderBin.html">
                RenderBin.js
              </a>
            
              
              <a class="source" href="RenderLeaf.html">
                RenderLeaf.js
              </a>
            
              
              <a class="source" href="RenderStage.html">
                RenderStage.js
              </a>
            
              
              <a class="source" href="Shader.html">
                Shader.js
              </a>
            
              
              <a class="source" href="Shape.html">
                Shape.js
              </a>
            
              
              <a class="source" href="Stack.html">
                Stack.js
              </a>
            
              
              <a class="source" href="State.html">
                State.js
              </a>
            
              
              <a class="source" href="StateAttribute.html">
                StateAttribute.js
              </a>
            
              
              <a class="source" href="StateGraph.html">
                StateGraph.js
              </a>
            
              
              <a class="source" href="StateSet.html">
                StateSet.js
              </a>
            
              
              <a class="source" href="Texture.html">
                Texture.js
              </a>
            
              
              <a class="source" href="TextureCubeMap.html">
                TextureCubeMap.js
              </a>
            
              
              <a class="source" href="TextureManager.html">
                TextureManager.js
              </a>
            
              
              <a class="source" href="Timer.html">
                Timer.js
              </a>
            
              
              <a class="source" href="Transform.html">
                Transform.js
              </a>
            
              
              <a class="source" href="TransformEnums.html">
                TransformEnums.js
              </a>
            
              
              <a class="source" href="TriangleIndexFunctor.html">
                TriangleIndexFunctor.js
              </a>
            
              
              <a class="source" href="Uniform.html">
                Uniform.js
              </a>
            
              
              <a class="source" href="UpdateVisitor.html">
                UpdateVisitor.js
              </a>
            
              
              <a class="source" href="Utils.html">
                Utils.js
              </a>
            
              
              <a class="source" href="Vec2.html">
                Vec2.js
              </a>
            
              
              <a class="source" href="Vec3.html">
                Vec3.js
              </a>
            
              
              <a class="source" href="Vec4.html">
                Vec4.js
              </a>
            
              
              <a class="source" href="Viewport.html">
                Viewport.js
              </a>
            
              
              <a class="source" href="WebGLCaps.html">
                WebGLCaps.js
              </a>
            
              
              <a class="source" href="osg.html">
                osg.js
              </a>
            
              
              <a class="source" href="Animation.html">
                Animation.js
              </a>
            
              
              <a class="source" href="AnimationUpdateCallback.html">
                AnimationUpdateCallback.js
              </a>
            
              
              <a class="source" href="BasicAnimationManager.html">
                BasicAnimationManager.js
              </a>
            
              
              <a class="source" href="Bone.html">
                Bone.js
              </a>
            
              
              <a class="source" href="Channel.html">
                Channel.js
              </a>
            
              
              <a class="source" href="CollectAnimationUpdateCallbackVisitor.html">
                CollectAnimationUpdateCallbackVisitor.js
              </a>
            
              
              <a class="source" href="CollectBoneVisitor.html">
                CollectBoneVisitor.js
              </a>
            
              
              <a class="source" href="Easing.html">
                Easing.js
              </a>
            
              
              <a class="source" href="FindNearestParentSkeleton.html">
                FindNearestParentSkeleton.js
              </a>
            
              
              <a class="source" href="Interpolator.html">
                Interpolator.js
              </a>
            
              
              <a class="source" href="MorphAttribute.html">
                MorphAttribute.js
              </a>
            
              
              <a class="source" href="MorphGeometry.html">
                MorphGeometry.js
              </a>
            
              
              <a class="source" href="RigGeometry.html">
                RigGeometry.js
              </a>
            
              
              <a class="source" href="RigTransformHardware.html">
                RigTransformHardware.js
              </a>
            
              
              <a class="source" href="Skeleton.html">
                Skeleton.js
              </a>
            
              
              <a class="source" href="SkinningAttribute.html">
                SkinningAttribute.js
              </a>
            
              
              <a class="source" href="StackedMatrix.html">
                StackedMatrix.js
              </a>
            
              
              <a class="source" href="StackedQuaternion.html">
                StackedQuaternion.js
              </a>
            
              
              <a class="source" href="StackedRotateAxis.html">
                StackedRotateAxis.js
              </a>
            
              
              <a class="source" href="StackedScale.html">
                StackedScale.js
              </a>
            
              
              <a class="source" href="StackedTranslate.html">
                StackedTranslate.js
              </a>
            
              
              <a class="source" href="Target.html">
                Target.js
              </a>
            
              
              <a class="source" href="UpdateBone.html">
                UpdateBone.js
              </a>
            
              
              <a class="source" href="UpdateMatrixTransform.html">
                UpdateMatrixTransform.js
              </a>
            
              
              <a class="source" href="UpdateMorph.html">
                UpdateMorph.js
              </a>
            
              
              <a class="source" href="UpdateRigGeometry.html">
                UpdateRigGeometry.js
              </a>
            
              
              <a class="source" href="UpdateSkeleton.html">
                UpdateSkeleton.js
              </a>
            
              
              <a class="source" href="channelType.html">
                channelType.js
              </a>
            
              
              <a class="source" href="osgAnimation.html">
                osgAnimation.js
              </a>
            
              
              <a class="source" href="DatabasePager.html">
                DatabasePager.js
              </a>
            
              
              <a class="source" href="Input.html">
                Input.js
              </a>
            
              
              <a class="source" href="Options.html">
                Options.js
              </a>
            
              
              <a class="source" href="ReaderParser.html">
                ReaderParser.js
              </a>
            
              
              <a class="source" href="osgDB.html">
                osgDB.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulator.html">
                FirstPersonManipulator.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorDeviceOrientationController.html">
                FirstPersonManipulatorDeviceOrientationController.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorHammerController.html">
                FirstPersonManipulatorHammerController.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorStandardMouseKeyboardController.html">
                FirstPersonManipulatorStandardMouseKeyboardController.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorWebVRController.html">
                FirstPersonManipulatorWebVRController.js
              </a>
            
              
              <a class="source" href="Manipulator.html">
                Manipulator.js
              </a>
            
              
              <a class="source" href="OrbitManipulator.html">
                OrbitManipulator.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorDeviceOrientationController.html">
                OrbitManipulatorDeviceOrientationController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorEnums.html">
                OrbitManipulatorEnums.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorGamePadController.html">
                OrbitManipulatorGamePadController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorHammerController.html">
                OrbitManipulatorHammerController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorLeapMotionController.html">
                OrbitManipulatorLeapMotionController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorStandardMouseKeyboardController.html">
                OrbitManipulatorStandardMouseKeyboardController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorWebVRController.html">
                OrbitManipulatorWebVRController.js
              </a>
            
              
              <a class="source" href="SwitchManipulator.html">
                SwitchManipulator.js
              </a>
            
              
              <a class="source" href="osgGA.html">
                osgGA.js
              </a>
            
              
              <a class="source" href="osgNameSpace.html">
                osgNameSpace.js
              </a>
            
              
              <a class="source" href="Compiler.html">
                Compiler.js
              </a>
            
              
              <a class="source" href="ShaderGenerator.html">
                ShaderGenerator.js
              </a>
            
              
              <a class="source" href="ShaderGeneratorProxy.html">
                ShaderGeneratorProxy.js
              </a>
            
              
              <a class="source" href="ShaderProcessor.html">
                ShaderProcessor.js
              </a>
            
              
              <a class="source" href="node.html">
                node.js
              </a>
            
              
              <a class="source" href="Node.html">
                Node.js
              </a>
            
              
              <a class="source" href="data.html">
                data.js
              </a>
            
              
              <a class="source" href="functions.html">
                functions.js
              </a>
            
              
              <a class="source" href="lights.html">
                lights.js
              </a>
            
              
              <a class="source" href="morph.html">
                morph.js
              </a>
            
              
              <a class="source" href="operations.html">
                operations.js
              </a>
            
              
              <a class="source" href="shadows.html">
                shadows.js
              </a>
            
              
              <a class="source" href="skinning.html">
                skinning.js
              </a>
            
              
              <a class="source" href="textures.html">
                textures.js
              </a>
            
              
              <a class="source" href="nodeFactory.html">
                nodeFactory.js
              </a>
            
              
              <a class="source" href="osgShader.html">
                osgShader.js
              </a>
            
              
              <a class="source" href="shaderLib.html">
                shaderLib.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="ShadowCastAttribute.html">
                ShadowCastAttribute.js
              </a>
            
              
              <a class="source" href="ShadowCastCompiler.html">
                ShadowCastCompiler.js
              </a>
            
              
              <a class="source" href="ShadowCastShaderGenerator.html">
                ShadowCastShaderGenerator.js
              </a>
            
              
              <a class="source" href="ShadowCasterVisitor.html">
                ShadowCasterVisitor.js
              </a>
            
              
              <a class="source" href="ShadowFrustumIntersection.html">
                ShadowFrustumIntersection.js
              </a>
            
              
              <a class="source" href="ShadowMap.html">
                ShadowMap.js
              </a>
            
              
              <a class="source" href="ShadowReceiveAttribute.html">
                ShadowReceiveAttribute.js
              </a>
            
              
              <a class="source" href="ShadowSettings.html">
                ShadowSettings.js
              </a>
            
              
              <a class="source" href="ShadowTechnique.html">
                ShadowTechnique.js
              </a>
            
              
              <a class="source" href="ShadowTexture.html">
                ShadowTexture.js
              </a>
            
              
              <a class="source" href="ShadowedScene.html">
                ShadowedScene.js
              </a>
            
              
              <a class="source" href="osgShadow.html">
                osgShadow.js
              </a>
            
              
              <a class="source" href="shaderLib.html">
                shaderLib.js
              </a>
            
              
              <a class="source" href="Text.html">
                Text.js
              </a>
            
              
              <a class="source" href="osgText.html">
                osgText.js
              </a>
            
              
              <a class="source" href="Composer.html">
                Composer.js
              </a>
            
              
              <a class="source" href="DisplayGeometryVisitor.html">
                DisplayGeometryVisitor.js
              </a>
            
              
              <a class="source" href="DisplayGraph.html">
                DisplayGraph.js
              </a>
            
              
              <a class="source" href="DisplayGraphNode.html">
                DisplayGraphNode.js
              </a>
            
              
              <a class="source" href="DisplayGraphRenderer.html">
                DisplayGraphRenderer.js
              </a>
            
              
              <a class="source" href="DisplayNormalVisitor.html">
                DisplayNormalVisitor.js
              </a>
            
              
              <a class="source" href="GizmoGeometry.html">
                GizmoGeometry.js
              </a>
            
              
              <a class="source" href="IntersectionVisitor.html">
                IntersectionVisitor.js
              </a>
            
              
              <a class="source" href="LineSegmentIntersector.html">
                LineSegmentIntersector.js
              </a>
            
              
              <a class="source" href="NodeGizmo.html">
                NodeGizmo.js
              </a>
            
              
              <a class="source" href="ParameterVisitor.html">
                ParameterVisitor.js
              </a>
            
              
              <a class="source" href="PolytopeIntersector.html">
                PolytopeIntersector.js
              </a>
            
              
              <a class="source" href="PolytopePrimitiveIntersector.html">
                PolytopePrimitiveIntersector.js
              </a>
            
              
              <a class="source" href="SphereIntersector.html">
                SphereIntersector.js
              </a>
            
              
              <a class="source" href="TangentSpaceGenerator.html">
                TangentSpaceGenerator.js
              </a>
            
              
              <a class="source" href="TriangleIntersector.html">
                TriangleIntersector.js
              </a>
            
              
              <a class="source" href="TriangleSphereIntersector.html">
                TriangleSphereIntersector.js
              </a>
            
              
              <a class="source" href="WebVR.html">
                WebVR.js
              </a>
            
              
              <a class="source" href="WebVRCustom.html">
                WebVRCustom.js
              </a>
            
              
              <a class="source" href="osgPool.html">
                osgPool.js
              </a>
            
              
              <a class="source" href="osgUtil.html">
                osgUtil.js
              </a>
            
              
              <a class="source" href="Renderer.html">
                Renderer.js
              </a>
            
              
              <a class="source" href="Scene.html">
                Scene.js
              </a>
            
              
              <a class="source" href="View.html">
                View.js
              </a>
            
              
              <a class="source" href="Viewer.html">
                Viewer.js
              </a>
            
              
              <a class="source" href="createStats.html">
                createStats.js
              </a>
            
              
              <a class="source" href="DeviceOrientation.html">
                DeviceOrientation.js
              </a>
            
              
              <a class="source" href="EventProxy.html">
                EventProxy.js
              </a>
            
              
              <a class="source" href="GamePad.html">
                GamePad.js
              </a>
            
              
              <a class="source" href="Hammer.html">
                Hammer.js
              </a>
            
              
              <a class="source" href="LeapMotion.html">
                LeapMotion.js
              </a>
            
              
              <a class="source" href="StandardMouseKeyboard.html">
                StandardMouseKeyboard.js
              </a>
            
              
              <a class="source" href="WebVR.html">
                WebVR.js
              </a>
            
              
              <a class="source" href="osgViewer.html">
                osgViewer.js
              </a>
            
              
              <a class="source" href="webgl-debug.html">
                webgl-debug.js
              </a>
            
              
              <a class="source" href="webgl-utils.html">
                webgl-utils.js
              </a>
            
              
              <a class="source" href="osgWrappers.html">
                osgWrappers.js
              </a>
            
              
              <a class="source" href="osg.html">
                osg.js
              </a>
            
              
              <a class="source" href="osgAnimation.html">
                osgAnimation.js
              </a>
            
              
              <a class="source" href="osgText.html">
                osgText.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>State.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">var</span> <span class="hljs-built_in">Map</span> = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Map'</span> );
<span class="hljs-keyword">var</span> Matrix = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Matrix'</span> );
<span class="hljs-keyword">var</span> Notify = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Notify'</span> );
<span class="hljs-keyword">var</span> <span class="hljs-built_in">Object</span> = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Object'</span> );
<span class="hljs-keyword">var</span> Program = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Program'</span> );
<span class="hljs-keyword">var</span> StateAttribute = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/StateAttribute'</span> );
<span class="hljs-keyword">var</span> Stack = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Stack'</span> );
<span class="hljs-keyword">var</span> Uniform = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Uniform'</span> );
<span class="hljs-keyword">var</span> MACROUTILS = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Utils'</span> );


<span class="hljs-keyword">var</span> State = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> shaderGeneratorProxy </span>) </span>{
    <span class="hljs-built_in">Object</span>.call( <span class="hljs-keyword">this</span> );

    <span class="hljs-keyword">this</span>._graphicContext = <span class="hljs-literal">undefined</span>;
    <span class="hljs-keyword">this</span>._shaderGeneratorProxy = shaderGeneratorProxy;

    <span class="hljs-keyword">if</span> ( shaderGeneratorProxy === <span class="hljs-literal">undefined</span> )
        <span class="hljs-built_in">console</span>.break();

    <span class="hljs-keyword">this</span>.currentVBO = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.vertexAttribList = [];
    <span class="hljs-keyword">this</span>.stateSets = <span class="hljs-keyword">new</span> Stack();
    <span class="hljs-keyword">this</span>._shaderGeneratorNames = <span class="hljs-keyword">new</span> Stack();
    <span class="hljs-keyword">this</span>.uniforms = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();

    <span class="hljs-keyword">this</span>.textureAttributeMapList = [];

    <span class="hljs-keyword">this</span>.attributeMap = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();

    <span class="hljs-keyword">this</span>.modelWorldMatrix = Uniform.createMatrix4( Matrix.create(), <span class="hljs-string">'ModelWorldMatrix'</span> );
    <span class="hljs-keyword">this</span>.viewMatrix = Uniform.createMatrix4( Matrix.create(), <span class="hljs-string">'ViewMatrix'</span> );
    <span class="hljs-keyword">this</span>.modelViewMatrix = Uniform.createMatrix4( Matrix.create(), <span class="hljs-string">'ModelViewMatrix'</span> );
    <span class="hljs-keyword">this</span>.projectionMatrix = Uniform.createMatrix4( Matrix.create(), <span class="hljs-string">'ProjectionMatrix'</span> );
    <span class="hljs-keyword">this</span>.normalMatrix = Uniform.createMatrix4( Matrix.create(), <span class="hljs-string">'NormalMatrix'</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>track uniform for color array enabled</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> arrayColorEnable = <span class="hljs-keyword">new</span> Stack();
    arrayColorEnable.globalDefault = Uniform.createFloat1( <span class="hljs-number">0.0</span>, <span class="hljs-string">'ArrayColorEnabled'</span> );

    <span class="hljs-keyword">this</span>.uniforms.setMap( {
        ArrayColorEnabled: arrayColorEnable
    } );


    <span class="hljs-keyword">this</span>._previousColorAttribPair = {};
    <span class="hljs-keyword">this</span>.vertexAttribMap = {};
    <span class="hljs-keyword">this</span>.vertexAttribMap._disable = [];
    <span class="hljs-keyword">this</span>.vertexAttribMap._keys = [];

    <span class="hljs-keyword">this</span>._frameStamp = <span class="hljs-literal">undefined</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>we dont use Map because in this use case with a few entries
{} is faster</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._programCommonUniformsCache = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>keep pointer on the last applied modelview matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._modelViewMatrix = <span class="hljs-literal">undefined</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>keep pointer on the last applied projection matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._projectionMatrix = <span class="hljs-literal">undefined</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>keep track of last applied program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._program = <span class="hljs-literal">undefined</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>inject a default program to initialize the stack Program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.applyAttribute( <span class="hljs-keyword">new</span> Program() );

    <span class="hljs-keyword">this</span>._numPushStateSet = <span class="hljs-number">0</span>;
};

State.prototype = MACROUTILS.objectLibraryClass( MACROUTILS.objectInherit( <span class="hljs-built_in">Object</span>.prototype, {

    getCacheUniformsApplyRenderLeaf: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._programCommonUniformsCache;
    },

    setGraphicContext: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> graphicContext </span>) </span>{
        <span class="hljs-keyword">this</span>._graphicContext = graphicContext;
    },

    getGraphicContext: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._graphicContext;
    },

    getShaderGeneratorProxy: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._shaderGeneratorProxy;
    },

    pushCheckOverride: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> stack, object, maskValue </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>object can be a Uniform, an Attribute, or a shader generator name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( stack.values().length === <span class="hljs-number">0</span> ) {
            stack.push( <span class="hljs-keyword">this</span>.getObjectPair( object, maskValue ) );
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( ( stack.back().value &amp; StateAttribute.OVERRIDE ) &amp;&amp; !( maskValue &amp; StateAttribute.PROTECTED ) ) {
            stack.push( stack.back() );
        } <span class="hljs-keyword">else</span> {
            stack.push( <span class="hljs-keyword">this</span>.getObjectPair( object, maskValue ) );
        }
    },

    pushStateSet: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> stateset </span>) </span>{
        <span class="hljs-keyword">this</span>._numPushStateSet++;
        <span class="hljs-keyword">this</span>.stateSets.push( stateset );

        <span class="hljs-keyword">if</span> ( stateset.attributeMap ) {
            <span class="hljs-keyword">this</span>.pushAttributeMap( <span class="hljs-keyword">this</span>.attributeMap, stateset.attributeMap );
        }

        <span class="hljs-keyword">if</span> ( stateset.textureAttributeMapList ) {
            <span class="hljs-keyword">var</span> list = stateset.textureAttributeMapList;
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> textureUnit = <span class="hljs-number">0</span>, l = list.length; textureUnit &lt; l; textureUnit++ ) {
                <span class="hljs-keyword">if</span> ( !list[ textureUnit ] ) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">var</span> textureUnitAttributeMap = <span class="hljs-keyword">this</span>.getOrCreateTextureAttributeMap( textureUnit );
                <span class="hljs-keyword">this</span>.pushAttributeMap( textureUnitAttributeMap, list[ textureUnit ] );
            }
        }

        <span class="hljs-keyword">if</span> ( stateset.uniforms ) {
            <span class="hljs-keyword">this</span>.pushUniformsList( <span class="hljs-keyword">this</span>.uniforms, stateset.uniforms );
        }
        <span class="hljs-keyword">var</span> generatorPair = stateset.getShaderGeneratorPair();
        <span class="hljs-keyword">if</span> ( generatorPair )
            <span class="hljs-keyword">this</span>.pushCheckOverride( <span class="hljs-keyword">this</span>._shaderGeneratorNames, generatorPair.getShaderGeneratorName(), generatorPair.getValue() );
    },

    getStateSetStackSize: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.stateSets.values().length;
    },

    insertStateSet: ( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> tmpStack = [];

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> pos, stateSet </span>) </span>{

            tmpStack.length = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> length = <span class="hljs-keyword">this</span>.getStateSetStackSize();
            <span class="hljs-keyword">while</span> ( length &gt; pos ) {
                tmpStack.push( <span class="hljs-keyword">this</span>.stateSets.back() );
                <span class="hljs-keyword">this</span>.popStateSet();
                length--;
            }

            <span class="hljs-keyword">this</span>.pushStateSet( stateSet );

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = tmpStack.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- ) {
                <span class="hljs-keyword">this</span>.pushStateSet( tmpStack[ i ] );
            }

        };
    } )(),

    removeStateSet: ( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> tmpStack = [];

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> pos </span>) </span>{

            <span class="hljs-keyword">var</span> length = <span class="hljs-keyword">this</span>.getStateSetStackSize();
            <span class="hljs-keyword">if</span> ( pos &gt;= length ) {
                Notify.warn( <span class="hljs-string">'Warning State:removeStateSet '</span>, pos, <span class="hljs-string">' out of range'</span> );
                <span class="hljs-keyword">return</span>;
            }

            tmpStack.length = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>record the StateSet above the one we intend to remove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">while</span> ( length - <span class="hljs-number">1</span> &gt; pos ) {
                tmpStack.push( <span class="hljs-keyword">this</span>.stateSets.back() );
                <span class="hljs-keyword">this</span>.popStateSet();
                length--;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>remove the intended StateSet as well</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.popStateSet();</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>push back the original ones that were above the remove StateSet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = tmpStack.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i-- ) {
                <span class="hljs-keyword">this</span>.pushStateSet( tmpStack[ i ] );
            }

        };
    } )(),</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>needed because we use a cache during the frame to avoid
applying uniform or operation. At each frame we need to
invalidate those informations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    resetCacheFrame: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._modelViewMatrix = <span class="hljs-keyword">this</span>._projectionMatrix = <span class="hljs-literal">undefined</span>;
    },

    resetStats: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._numPushStateSet = <span class="hljs-number">0</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>apply program if needed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    applyProgram: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> program </span>) </span>{
        <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._program === program ) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">this</span>._program = program;
        <span class="hljs-keyword">this</span>.getGraphicContext().useProgram( program );
    },

    applyModelViewMatrix: ( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> normal = Matrix.create();

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> matrix </span>) </span>{

            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._modelViewMatrix === matrix ) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">this</span>.getLastProgramApplied();

            <span class="hljs-keyword">var</span> mu = <span class="hljs-keyword">this</span>.modelViewMatrix;
            <span class="hljs-keyword">var</span> mul = program._uniformsCache[ mu.getName() ];
            <span class="hljs-keyword">if</span> ( mul ) {

                mu.setInternalArray( matrix );
                mu.apply( <span class="hljs-keyword">this</span>.getGraphicContext(), mul );
            }

            <span class="hljs-keyword">var</span> sendNormal;
            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._modelViewMatrix ) {
                sendNormal = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>check if we need to push normal
test rotation component, if not diff
we dont need to send normal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">11</span>; i++ ) {
                    <span class="hljs-keyword">if</span> ( matrix[ i ] !== <span class="hljs-keyword">this</span>._modelViewMatrix[ i ] ) {
                        sendNormal = <span class="hljs-literal">true</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
            } <span class="hljs-keyword">else</span> {
                sendNormal = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-keyword">if</span> ( sendNormal ) {
                mu = <span class="hljs-keyword">this</span>.normalMatrix;
                mul = program._uniformsCache[ mu.getName() ];
                <span class="hljs-keyword">if</span> ( mul ) {
                    Matrix.copy( matrix, normal );

                    normal[ <span class="hljs-number">12</span> ] = <span class="hljs-number">0.0</span>;
                    normal[ <span class="hljs-number">13</span> ] = <span class="hljs-number">0.0</span>;
                    normal[ <span class="hljs-number">14</span> ] = <span class="hljs-number">0.0</span>;

                    Matrix.inverse( normal, normal );
                    Matrix.transpose( normal, normal );

                    mu.setInternalArray( normal );
                    mu.apply( <span class="hljs-keyword">this</span>.getGraphicContext(), mul );
                }
            }

            <span class="hljs-keyword">this</span>._modelViewMatrix = matrix;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        };
    } )(),

    applyProjectionMatrix: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> matrix </span>) </span>{

        <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._projectionMatrix === matrix ) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">this</span>._projectionMatrix = matrix;
        <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">this</span>.getLastProgramApplied();
        <span class="hljs-keyword">var</span> mu = <span class="hljs-keyword">this</span>.projectionMatrix;

        <span class="hljs-keyword">var</span> mul = program._uniformsCache[ mu.getName() ];
        <span class="hljs-keyword">if</span> ( mul ) {

            mu.setInternalArray( matrix );
            mu.apply( <span class="hljs-keyword">this</span>.getGraphicContext(), mul );

        }
    },

    applyStateSet: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> stateset </span>) </span>{
        <span class="hljs-keyword">this</span>.pushStateSet( stateset );
        <span class="hljs-keyword">this</span>.apply();
        <span class="hljs-keyword">this</span>.popStateSet();
    },

    getStateSetStackHash: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> values = <span class="hljs-keyword">this</span>.stateSets.values();
        <span class="hljs-keyword">var</span> sum = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = values.length; i &lt; l; i++ )
            sum += values[ i ].getInstanceID();
        <span class="hljs-keyword">return</span> sum;
    },

    popAllStateSets: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">while</span> ( <span class="hljs-keyword">this</span>.stateSets.values().length ) {
            <span class="hljs-keyword">this</span>.popStateSet();
        }
    },

    popStateSet: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.stateSets.empty() ) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">var</span> stateset = <span class="hljs-keyword">this</span>.stateSets.pop();

        <span class="hljs-keyword">if</span> ( stateset.attributeMap ) {
            <span class="hljs-keyword">this</span>.popAttributeMap( <span class="hljs-keyword">this</span>.attributeMap, stateset.attributeMap );
        }

        <span class="hljs-keyword">if</span> ( stateset.textureAttributeMapList ) {
            <span class="hljs-keyword">var</span> list = stateset.textureAttributeMapList;
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> textureUnit = <span class="hljs-number">0</span>, l = list.length; textureUnit &lt; l; textureUnit++ ) {
                <span class="hljs-keyword">if</span> ( !list[ textureUnit ] ) {
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-keyword">this</span>.popAttributeMap( <span class="hljs-keyword">this</span>.textureAttributeMapList[ textureUnit ], list[ textureUnit ] );
            }
        }

        <span class="hljs-keyword">if</span> ( stateset.uniforms ) {
            <span class="hljs-keyword">this</span>.popUniformsList( <span class="hljs-keyword">this</span>.uniforms, stateset.uniforms );
        }

        <span class="hljs-keyword">if</span> ( stateset.getShaderGeneratorPair() ) {
            <span class="hljs-keyword">this</span>._shaderGeneratorNames.pop();
        }
    },

    haveAppliedAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> attribute </span>) </span>{

        <span class="hljs-keyword">var</span> key = attribute.getTypeMember();
        <span class="hljs-keyword">var</span> attributeStack = <span class="hljs-keyword">this</span>.attributeMap[ key ];
        attributeStack.lastApplied = attribute;
        attributeStack.asChanged = <span class="hljs-literal">true</span>;

    },

    applyAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> attribute </span>) </span>{

        <span class="hljs-keyword">var</span> key = attribute.getTypeMember();

        <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.attributeMap;
        <span class="hljs-keyword">var</span> attributeStack = attributeMap[ key ];

        <span class="hljs-keyword">if</span> ( !attributeStack ) {
            attributeStack = <span class="hljs-keyword">new</span> Stack();
            attributeMap[ key ] = attributeStack;
            attributeMap[ key ].globalDefault = attribute.cloneType();
            <span class="hljs-keyword">this</span>.attributeMap.dirty();
        }

        <span class="hljs-keyword">if</span> ( attributeStack.lastApplied !== attribute ) {

            <span class="hljs-keyword">if</span> ( attribute.apply ) {
                attribute.apply( <span class="hljs-keyword">this</span> );
            }
            attributeStack.lastApplied = attribute;
            attributeStack.asChanged = <span class="hljs-literal">true</span>;
        }
    },

    applyTextureAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> unit, attribute </span>) </span>{


        <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.getGraphicContext();
        gl.activeTexture( gl.TEXTURE0 + unit );
        <span class="hljs-keyword">var</span> key = attribute.getTypeMember();


        <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ] ) {
            <span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
        }

        <span class="hljs-keyword">var</span> textureUnitAttributeMap = <span class="hljs-keyword">this</span>.getOrCreateTextureAttributeMap( unit );
        <span class="hljs-keyword">var</span> attributeStack = textureUnitAttributeMap[ key ];

        <span class="hljs-keyword">if</span> ( !attributeStack ) {

            attributeStack = <span class="hljs-keyword">new</span> Stack();
            textureUnitAttributeMap[ key ] = attributeStack;
            textureUnitAttributeMap.dirty();
            attributeStack.globalDefault = attribute.cloneType();

        }

        <span class="hljs-keyword">if</span> ( attributeStack.lastApplied !== attribute ) {

            <span class="hljs-keyword">if</span> ( attribute.apply ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>there is a texture we bind it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                attribute.apply( <span class="hljs-keyword">this</span>, unit );</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO: optimization:
if attribute.isTextureNull()
only bind if last Framebuffer Texture Binded
are the same as those we try to write from
need rewrite of the fbo attachments system to keep history
and state to keep last fbo textures binded.
(applyTextureAttributeStack concerned too)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
            attributeStack.lastApplied = attribute;
            attributeStack.asChanged = <span class="hljs-literal">true</span>;
        }
    },

    getLastProgramApplied: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.attributeMap.Program.lastApplied;
    },

    applyDefault: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>reset GL State To Default
we skip the textures/uniforms/shaders call since they are not necessary</p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>noticed that we accumulate lot of stack, maybe because of the stateGraph
CP: ^^ really ? check it / report an issue</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>.popAllStateSets();

        <span class="hljs-keyword">this</span>.applyAttributeMap( <span class="hljs-keyword">this</span>.attributeMap );
        <span class="hljs-keyword">this</span>.applyTextureAttributeMapList( <span class="hljs-keyword">this</span>.textureAttributeMapList );
    },

    apply: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> lastProgram = <span class="hljs-keyword">this</span>.getLastProgramApplied();

        <span class="hljs-keyword">this</span>.applyAttributeMap( <span class="hljs-keyword">this</span>.attributeMap );
        <span class="hljs-keyword">this</span>.applyTextureAttributeMapList( <span class="hljs-keyword">this</span>.textureAttributeMapList );

        <span class="hljs-keyword">var</span> generatedProgram = <span class="hljs-keyword">this</span>._generateAndApplyProgram();

        <span class="hljs-keyword">if</span> ( generatedProgram ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>will cache uniform and apply them with the program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">this</span>._applyGeneratedProgramUniforms( <span class="hljs-keyword">this</span>.attributeMap.Program.lastApplied );

        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>custom program so we will iterate on uniform from the program and apply them
but in order to be able to use Attribute in the state graph we will check if
our program want them. It must be defined by the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>._applyCustomProgramUniforms( <span class="hljs-keyword">this</span>.attributeMap.Program.lastApplied );

        }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>reset reference of last applied matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( lastProgram !== <span class="hljs-keyword">this</span>.getLastProgramApplied() ) {
            <span class="hljs-keyword">this</span>._modelViewMatrix = <span class="hljs-literal">undefined</span>;
            <span class="hljs-keyword">this</span>._projectionMatrix = <span class="hljs-literal">undefined</span>;
        }
    },


    applyAttributeMap: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> attributeMap </span>) </span>{

        <span class="hljs-keyword">var</span> attributeStack;
        <span class="hljs-keyword">var</span> attributeMapKeys = attributeMap.getKeys();

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = attributeMapKeys.length; i &lt; l; i++ ) {
            <span class="hljs-keyword">var</span> key = attributeMapKeys[ i ];

            attributeStack = attributeMap[ key ];
            <span class="hljs-keyword">if</span> ( !attributeStack || !attributeStack.asChanged ) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">var</span> attribute;
            <span class="hljs-keyword">if</span> ( attributeStack.values().length === <span class="hljs-number">0</span> ) {
                attribute = attributeStack.globalDefault;
            } <span class="hljs-keyword">else</span> {
                attribute = attributeStack.back().object;
            }

            <span class="hljs-comment">/*develblock:start*/</span>
            Notify.assert( key === attribute.getTypeMember(), <span class="hljs-string">'State:applyAttributeMap attribute key '</span> + key + <span class="hljs-string">' !== '</span> + attribute.getTypeMember() );
            <span class="hljs-comment">/*develblock:end*/</span>


            <span class="hljs-keyword">if</span> ( attributeStack.lastApplied !== attribute ) {

                <span class="hljs-keyword">if</span> ( attribute.apply )
                    attribute.apply( <span class="hljs-keyword">this</span> );

                attributeStack.lastApplied = attribute;

            }
            attributeStack.asChanged = <span class="hljs-literal">false</span>;

        }
    },

    getObjectPair: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> object, value </span>) </span>{
        <span class="hljs-keyword">return</span> {
            object: object,
            value: value
        };
    },

    pushUniformsList: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> uniformMap, stateSetUniformMap </span>) </span>{
        <span class="hljs-comment">/*jshint bitwise: false */</span>
        <span class="hljs-keyword">var</span> name;
        <span class="hljs-keyword">var</span> uniform;

        <span class="hljs-keyword">var</span> stateSetUniformMapKeys = stateSetUniformMap.getKeys();

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = stateSetUniformMapKeys.length; i &lt; l; i++ ) {
            <span class="hljs-keyword">var</span> key = stateSetUniformMapKeys[ i ];
            <span class="hljs-keyword">var</span> uniformPair = stateSetUniformMap[ key ];
            uniform = uniformPair.getUniform();
            name = uniform.getName();
            <span class="hljs-keyword">if</span> ( uniformMap[ name ] === <span class="hljs-literal">undefined</span> ) {
                uniformMap[ name ] = <span class="hljs-keyword">new</span> Stack();
                uniformMap[ name ].globalDefault = uniform;
                uniformMap.dirty();
            }

            <span class="hljs-keyword">this</span>.pushCheckOverride( uniformMap[ name ], uniform, uniformPair.getValue() );
        }
        <span class="hljs-comment">/*jshint bitwise: true */</span>
    },

    popUniformsList: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> uniformMap, stateSetUniformMap </span>) </span>{

        <span class="hljs-keyword">var</span> stateSetUniformMapKeys = stateSetUniformMap.getKeys();

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = stateSetUniformMapKeys.length; i &lt; l; i++ ) {
            <span class="hljs-keyword">var</span> key = stateSetUniformMapKeys[ i ];
            uniformMap[ key ].pop();
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>this funtion must called only if stack has changed
check applyTextureAttributeMapList</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _applyTextureAttributeStack: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> gl, textureUnit, attributeStack </span>) </span>{

        <span class="hljs-keyword">var</span> attribute;
        <span class="hljs-keyword">if</span> ( attributeStack.values().length === <span class="hljs-number">0</span> ) {
            attribute = attributeStack.globalDefault;
        } <span class="hljs-keyword">else</span> {
            attribute = attributeStack.back().object;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>if the the stack has changed but the last applied attribute is the same
then we dont need to apply it again</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( attributeStack.lastApplied !== attribute ) {

            gl.activeTexture( gl.TEXTURE0 + textureUnit );
            attribute.apply( <span class="hljs-keyword">this</span>, textureUnit );

            attributeStack.lastApplied = attribute;
        }

        attributeStack.asChanged = <span class="hljs-literal">false</span>;
    },

    applyTextureAttributeMapList: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> textureAttributesMapList </span>) </span>{
        <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>._graphicContext;
        <span class="hljs-keyword">var</span> textureAttributeMap;

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> textureUnit = <span class="hljs-number">0</span>, l = textureAttributesMapList.length; textureUnit &lt; l; textureUnit++ ) {
            textureAttributeMap = textureAttributesMapList[ textureUnit ];
            <span class="hljs-keyword">if</span> ( !textureAttributeMap ) {
                <span class="hljs-keyword">continue</span>;
            }


            <span class="hljs-keyword">var</span> textureAttributeMapKeys = textureAttributeMap.getKeys();

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, lt = textureAttributeMapKeys.length; i &lt; lt; i++ ) {
                <span class="hljs-keyword">var</span> key = textureAttributeMapKeys[ i ];

                <span class="hljs-keyword">var</span> attributeStack = textureAttributeMap[ key ];</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>skip if not stack or not changed in stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> ( !attributeStack || !attributeStack.asChanged ) <span class="hljs-keyword">continue</span>;

                <span class="hljs-keyword">this</span>._applyTextureAttributeStack( gl, textureUnit, attributeStack );</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>var attribute;
if ( attributeStack.values().length === 0 ) {
    attribute = attributeStack.globalDefault;
} else {
    attribute = attributeStack.back().object;
}
if ( attributeStack.asChanged ) {</p>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <pre><code>gl.activeTexture( gl.TEXTURE0 + textureUnit );
attribute.apply( <span class="hljs-keyword">this</span>, textureUnit );
attributeStack.lastApplied = attribute;
attributeStack.asChanged = <span class="hljs-literal">false</span>;
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
        }
    },

    setGlobalDefaultValue: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> attribute </span>) </span>{
        Notify.log( <span class="hljs-string">'setGlobalDefaultValue is deprecated, use instead setGlobalDefaultAttribute'</span> );
        <span class="hljs-keyword">this</span>.setGlobalDefaultAttribute( attribute );
    },

    setGlobalDefaultAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> attribute </span>) </span>{
        <span class="hljs-keyword">var</span> typeMember = attribute.getTypeMember();
        <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.attributeMap;

        <span class="hljs-keyword">if</span> ( attributeMap[ typeMember ] === <span class="hljs-literal">undefined</span> ) {
            attributeMap[ typeMember ] = <span class="hljs-keyword">new</span> Stack();
            attributeMap.dirty();
        }

        attributeMap[ typeMember ].globalDefault = attribute;
    },

    getGlobalDefaultAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> typeMember </span>) </span>{
        <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.attributeMap;
        <span class="hljs-keyword">if</span> ( attributeMap[ typeMember ] === <span class="hljs-literal">undefined</span> ) <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;

        <span class="hljs-keyword">return</span> attributeMap[ typeMember ].globalDefault;
    },

    setGlobalDefaultTextureAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> unit, attribute </span>) </span>{
        <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.getOrCreateTextureAttributeMap( unit );

        <span class="hljs-keyword">var</span> typeMember = attribute.getTypeMember();
        <span class="hljs-keyword">if</span> ( attributeMap[ typeMember ] === <span class="hljs-literal">undefined</span> ) {
            attributeMap[ typeMember ] = <span class="hljs-keyword">new</span> Stack();
            attributeMap.dirty();
        }

        <span class="hljs-keyword">var</span> <span class="hljs-keyword">as</span> = attributeMap[ typeMember ];
        <span class="hljs-keyword">as</span>.globalDefault = attribute;
    },

    getGlobalDefaultTextureAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> unit, typeMember </span>) </span>{
        <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.getOrCreateTextureAttributeMap( unit );
        <span class="hljs-keyword">var</span> <span class="hljs-keyword">as</span> = attributeMap[ typeMember ];
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">as</span>.globalDefault;
    },

    getOrCreateTextureAttributeMap: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> unit </span>) </span>{
        <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ] ) <span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ];
    },

    pushAttributeMap: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> attributeMap, stateSetAttributeMap </span>) </span>{
        <span class="hljs-comment">/*jshint bitwise: false */</span>
        <span class="hljs-keyword">var</span> attributeStack;
        <span class="hljs-keyword">var</span> stateSetAttributeMapKeys = stateSetAttributeMap.getKeys();

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = stateSetAttributeMapKeys.length; i &lt; l; i++ ) {

            <span class="hljs-keyword">var</span> type = stateSetAttributeMapKeys[ i ];
            <span class="hljs-keyword">var</span> attributePair = stateSetAttributeMap[ type ];
            <span class="hljs-keyword">var</span> attribute = attributePair.getAttribute();

            <span class="hljs-keyword">if</span> ( attributeMap[ type ] === <span class="hljs-literal">undefined</span> ) {
                attributeMap[ type ] = <span class="hljs-keyword">new</span> Stack();
                attributeMap[ type ].globalDefault = attribute.cloneType();

                attributeMap.dirty();
            }

            attributeStack = attributeMap[ type ];
            <span class="hljs-keyword">this</span>.pushCheckOverride( attributeStack, attribute, attributePair.getValue() );
            attributeStack.asChanged = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">/*jshint bitwise: true */</span>
    },

    popAttributeMap: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> attributeMap, stateSetAttributeMap </span>) </span>{

        <span class="hljs-keyword">var</span> attributeStack;
        <span class="hljs-keyword">var</span> stateSetAttributeMapKeys = stateSetAttributeMap.getKeys();

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = stateSetAttributeMapKeys.length; i &lt; l; i++ ) {

            <span class="hljs-keyword">var</span> type = stateSetAttributeMapKeys[ i ];
            attributeStack = attributeMap[ type ];
            attributeStack.pop();
            attributeStack.asChanged = <span class="hljs-literal">true</span>;

        }
    },

    setIndexArray: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> array </span>) </span>{
        <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>._graphicContext;
        <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.currentIndexVBO !== array ) {
            array.bind( gl );
            <span class="hljs-keyword">this</span>.currentIndexVBO = array;
        }
        <span class="hljs-keyword">if</span> ( array.isDirty() ) {
            array.compile( gl );
        }
    },

    lazyDisablingOfVertexAttributes: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> keys = <span class="hljs-keyword">this</span>.vertexAttribMap._keys;
        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = keys.length; i &lt; l; i++ ) {
            <span class="hljs-keyword">var</span> attr = keys[ i ];
            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.vertexAttribMap[ attr ] ) {
                <span class="hljs-keyword">this</span>.vertexAttribMap._disable[ attr ] = <span class="hljs-literal">true</span>;
            }
        }
    },

    applyDisablingOfVertexAttributes: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> keys = <span class="hljs-keyword">this</span>.vertexAttribMap._keys;
        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = keys.length; i &lt; l; i++ ) {
            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.vertexAttribMap._disable[ keys[ i ] ] === <span class="hljs-literal">true</span> ) {
                <span class="hljs-keyword">var</span> attr = keys[ i ];
                <span class="hljs-keyword">this</span>._graphicContext.disableVertexAttribArray( attr );
                <span class="hljs-keyword">this</span>.vertexAttribMap._disable[ attr ] = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">this</span>.vertexAttribMap[ attr ] = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">this</span>.attributeMap.Program.lastApplied;

        <span class="hljs-keyword">if</span> ( !program._uniformsCache.ArrayColorEnabled ||
            !program._attributesCache.Color ) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// no color uniform or attribute used, exit</span>


        <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.getGraphicContext();

        <span class="hljs-keyword">var</span> hasColorAttrib = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>check if we have colorAttribute on the current geometry</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> color = program._attributesCache.Color;
        hasColorAttrib = <span class="hljs-keyword">this</span>.vertexAttribMap[ color ];</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>check per program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> previousColorAttrib = <span class="hljs-keyword">this</span>._previousColorAttribPair[ program.getInstanceID() ];</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>no change with the same program -&gt; exit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( previousColorAttrib === hasColorAttrib ) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">this</span>._previousColorAttribPair[ program.getInstanceID() ] = hasColorAttrib;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>update uniform</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> uniform = <span class="hljs-keyword">this</span>.uniforms.ArrayColorEnabled.globalDefault;

        <span class="hljs-keyword">if</span> ( hasColorAttrib ) {
            uniform.setFloat( <span class="hljs-number">1.0</span> );
        } <span class="hljs-keyword">else</span> {
            uniform.setFloat( <span class="hljs-number">0.0</span> );
        }
        uniform.apply( gl, program._uniformsCache.ArrayColorEnabled );

    },

    setVertexAttribArray: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> attrib, array, normalize </span>) </span>{
        <span class="hljs-keyword">var</span> vertexAttribMap = <span class="hljs-keyword">this</span>.vertexAttribMap;
        vertexAttribMap._disable[ attrib ] = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>._graphicContext;
        <span class="hljs-keyword">var</span> binded = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> ( array.isDirty() ) {
            array.bind( gl );
            array.compile( gl );
            binded = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">var</span> currentArray = vertexAttribMap[ attrib ];
        <span class="hljs-keyword">if</span> ( currentArray !== array ) {

            <span class="hljs-keyword">if</span> ( !binded ) {
                array.bind( gl );
            }

            <span class="hljs-keyword">if</span> ( !currentArray ) {
                gl.enableVertexAttribArray( attrib );</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>can be === false (so undefined check is important)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> ( currentArray === <span class="hljs-literal">undefined</span> )
                    vertexAttribMap._keys.push( attrib );

            }

            vertexAttribMap[ attrib ] = array;
            gl.vertexAttribPointer( attrib, array.getItemSize(), array.getType(), normalize, <span class="hljs-number">0</span>, <span class="hljs-number">0</span> );
        }
    },


    _getActiveUniformsFromProgramAttributes: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> program, activeUniformsList </span>) </span>{

        <span class="hljs-keyword">var</span> attributeMapStack = <span class="hljs-keyword">this</span>.attributeMap;

        <span class="hljs-keyword">var</span> attributeKeys = program.trackAttributes.attributeKeys;

        <span class="hljs-keyword">if</span> ( attributeKeys.length &gt; <span class="hljs-number">0</span> ) {

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = attributeKeys.length; i &lt; l; i++ ) {

                <span class="hljs-keyword">var</span> key = attributeKeys[ i ];
                <span class="hljs-keyword">var</span> attributeStack = attributeMapStack[ key ];
                <span class="hljs-keyword">if</span> ( attributeStack === <span class="hljs-literal">undefined</span> ) {
                    <span class="hljs-keyword">continue</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>we just need the uniform list and not the attribute itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> attribute = attributeStack.globalDefault;
                <span class="hljs-keyword">if</span> ( attribute.getOrCreateUniforms === <span class="hljs-literal">undefined</span> ) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">var</span> uniformMap = attribute.getOrCreateUniforms();
                <span class="hljs-keyword">var</span> uniformKeys = uniformMap.getKeys();

                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> a = <span class="hljs-number">0</span>, b = uniformKeys.length; a &lt; b; a++ ) {
                    activeUniformsList.push( uniformMap[ uniformKeys[ a ] ] );
                }
            }

        }
    },

    _getActiveUniformsFromProgramTextureAttributes: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> program, activeUniformsList </span>) </span>{

        <span class="hljs-keyword">var</span> textureAttributeKeysList = program.trackAttributes.textureAttributeKeys;
        <span class="hljs-keyword">if</span> ( textureAttributeKeysList === <span class="hljs-literal">undefined</span> ) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> unit = <span class="hljs-number">0</span>, nbUnit = textureAttributeKeysList.length; unit &lt; nbUnit; unit++ ) {

            <span class="hljs-keyword">var</span> textureAttributeKeys = textureAttributeKeysList[ unit ];
            <span class="hljs-keyword">if</span> ( textureAttributeKeys === <span class="hljs-literal">undefined</span> ) <span class="hljs-keyword">continue</span>;

            <span class="hljs-keyword">var</span> unitTextureAttributeList = <span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ];
            <span class="hljs-keyword">if</span> ( unitTextureAttributeList === <span class="hljs-literal">undefined</span> ) <span class="hljs-keyword">continue</span>;

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = textureAttributeKeys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> key = textureAttributeKeys[ i ];

                <span class="hljs-keyword">var</span> attributeStack = unitTextureAttributeList[ key ];
                <span class="hljs-keyword">if</span> ( attributeStack === <span class="hljs-literal">undefined</span> ) {
                    <span class="hljs-keyword">continue</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>we just need the uniform list and not the attribute itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> attribute = attributeStack.globalDefault;
                <span class="hljs-keyword">if</span> ( attribute.getOrCreateUniforms === <span class="hljs-literal">undefined</span> ) {
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-keyword">var</span> uniformMap = attribute.getOrCreateUniforms();
                <span class="hljs-keyword">var</span> uniformMapKeys = uniformMap.getKeys();

                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> a = <span class="hljs-number">0</span>, b = uniformMapKeys.length; a &lt; b; a++ ) {
                    activeUniformsList.push( uniformMap[ uniformMapKeys[ a ] ] );
                }
            }
        }
    },

    _cacheUniformsForCustomProgram: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> program, activeUniformsList </span>) </span>{

        <span class="hljs-keyword">this</span>._getActiveUniformsFromProgramAttributes( program, activeUniformsList );

        <span class="hljs-keyword">this</span>._getActiveUniformsFromProgramTextureAttributes( program, activeUniformsList );

        <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>._graphicContext;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>now we have a list on uniforms we want to track but we will filter them to use only what is needed by our program
not that if you create a uniforms whith the same name of a tracked attribute, and it will override it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> uniformsFinal = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = activeUniformsList.length; i &lt; l; i++ ) {
            <span class="hljs-keyword">var</span> u = activeUniformsList[ i ];
            <span class="hljs-keyword">var</span> uniformName = u.getName();
            <span class="hljs-keyword">var</span> loc = gl.getUniformLocation( program._program, uniformName );
            <span class="hljs-keyword">if</span> ( loc !== <span class="hljs-literal">undefined</span> &amp;&amp; loc !== <span class="hljs-literal">null</span> ) {
                uniformsFinal[ uniformName ] = u;
            }
        }
        uniformsFinal.dirty();
        program.trackUniforms = uniformsFinal;

    },

    _applyCustomProgramUniforms: ( <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> activeUniformsList = [];

        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> program </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>custom program so we will iterate on uniform from the program and apply them
but in order to be able to use Attribute in the state graph we will check if
our program want them. It must be defined by the user</p>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>first time we see attributes key, so we will keep a list of uniforms from attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            activeUniformsList.length = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>fill the program with cached active uniforms map from attributes and texture attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( program.trackAttributes !== <span class="hljs-literal">undefined</span> &amp;&amp; program.trackUniforms === <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">this</span>._cacheUniformsForCustomProgram( program, activeUniformsList );
            }

            <span class="hljs-keyword">var</span> programUniformMap = program._uniformsCache;
            <span class="hljs-keyword">var</span> programUniformKeys = programUniformMap.getKeys();
            <span class="hljs-keyword">var</span> uniformMapStackContent = <span class="hljs-keyword">this</span>.uniforms;

            <span class="hljs-keyword">var</span> programTrackUniformMap;
            <span class="hljs-keyword">if</span> ( program.trackUniforms )
                programTrackUniformMap = program.trackUniforms;

            <span class="hljs-keyword">var</span> uniform;
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = programUniformKeys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> uniformKey = programUniformKeys[ i ];
                <span class="hljs-keyword">var</span> location = programUniformMap[ uniformKey ];
                <span class="hljs-keyword">var</span> uniformStack = uniformMapStackContent[ uniformKey ];

                <span class="hljs-keyword">if</span> ( uniformStack === <span class="hljs-literal">undefined</span> ) {

                    <span class="hljs-keyword">if</span> ( programTrackUniformMap !== <span class="hljs-literal">undefined</span> ) {
                        uniform = programTrackUniformMap[ uniformKey ];
                        <span class="hljs-keyword">if</span> ( uniform !== <span class="hljs-literal">undefined</span> ) {
                            uniform.apply( <span class="hljs-keyword">this</span>._graphicContext, location );
                        }
                    }

                } <span class="hljs-keyword">else</span> {

                    <span class="hljs-keyword">if</span> ( uniformStack.values().length === <span class="hljs-number">0</span> ) {
                        uniform = uniformStack.globalDefault;
                    } <span class="hljs-keyword">else</span> {
                        uniform = uniformStack.back().object;
                    }
                    uniform.apply( <span class="hljs-keyword">this</span>._graphicContext, location );

                }
            }
        };
    } )(),</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>apply a generated program if necessary
It build a Shader from the shader generator
it apply for the following condition
the user has not put a Pogram in the stack or if he has he added one with OFF</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _generateAndApplyProgram: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.attributeMap;
        <span class="hljs-keyword">if</span> ( attributeMap.Program !== <span class="hljs-literal">undefined</span> &amp;&amp; attributeMap.Program.values().length !== <span class="hljs-number">0</span> &amp;&amp; attributeMap.Program.back().value !== StateAttribute.OFF )
            <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>no custom program look into the stack of ShaderGenerator name
what we should use to generate a program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">var</span> last = <span class="hljs-keyword">this</span>._shaderGeneratorNames.back();
        <span class="hljs-keyword">var</span> shaderGenerator = <span class="hljs-keyword">this</span>._shaderGeneratorProxy.getShaderGenerator( last ? last.object : <span class="hljs-literal">undefined</span> );

        <span class="hljs-keyword">var</span> program = shaderGenerator.getOrCreateProgram( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">this</span>.applyAttribute( program );
        <span class="hljs-keyword">return</span> program;
    },

    _computeForeignUniforms: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> programUniformMap, activeUniformMap </span>) </span>{

        <span class="hljs-keyword">var</span> uniformMapKeys = programUniformMap.getKeys();
        <span class="hljs-keyword">var</span> uniformMap = programUniformMap;

        <span class="hljs-keyword">var</span> foreignUniforms = [];
        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = uniformMapKeys.length; i &lt; l; i++ ) {

            <span class="hljs-keyword">var</span> name = uniformMapKeys[ i ];
            <span class="hljs-keyword">var</span> location = uniformMap[ name ];

            <span class="hljs-keyword">if</span> ( location !== <span class="hljs-literal">undefined</span> &amp;&amp; activeUniformMap[ name ] === <span class="hljs-literal">undefined</span> ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>filter ‘standard’ uniform matrix that will be applied for all shader</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> ( name !== <span class="hljs-keyword">this</span>.modelViewMatrix.getName() &amp;&amp;
                    name !== <span class="hljs-keyword">this</span>.modelWorldMatrix.getName() &amp;&amp;
                    name !== <span class="hljs-keyword">this</span>.viewMatrix.getName() &amp;&amp;
                    name !== <span class="hljs-keyword">this</span>.projectionMatrix.getName() &amp;&amp;
                    name !== <span class="hljs-keyword">this</span>.normalMatrix.getName() &amp;&amp;
                    name !== <span class="hljs-string">'ArrayColorEnabled'</span> ) {
                    foreignUniforms.push( name );
                }
            }

        }

        <span class="hljs-keyword">return</span> foreignUniforms;
    },

    _removeUniformsNotRequiredByProgram: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> activeUniformMap, programUniformMap </span>) </span>{

        <span class="hljs-keyword">var</span> activeUniformMapKeys = activeUniformMap.getKeys();

        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = activeUniformMapKeys.length; i &lt; l; i++ ) {
            <span class="hljs-keyword">var</span> name = activeUniformMapKeys[ i ];
            <span class="hljs-keyword">var</span> location = programUniformMap[ name ];
            <span class="hljs-keyword">if</span> ( location === <span class="hljs-literal">undefined</span> || location === <span class="hljs-literal">null</span> ) {
                <span class="hljs-keyword">delete</span> activeUniformMap[ name ];
                activeUniformMap.dirty();
            }
        }
    },


    _cacheUniformsForGeneratedProgram: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> program </span>) </span>{

        <span class="hljs-keyword">var</span> foreignUniforms = <span class="hljs-keyword">this</span>._computeForeignUniforms( program._uniformsCache, program.activeUniforms );
        program.foreignUniforms = foreignUniforms;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>remove uniforms listed by attributes (getActiveUniforms) but not required by the program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._removeUniformsNotRequiredByProgram( program.activeUniforms, program._uniformsCache );

    },

    _applyGeneratedProgramUniforms: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> program </span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>note that about TextureAttribute that need uniform on unit we would need to improve
the current uniformList …</p>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>when we apply the shader for the first time, we want to compute the active uniforms for this shader and the list of uniforms not extracted from attributes called foreignUniforms</p>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>typically the following code will be executed once on the first execution of generated program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">var</span> foreignUniformKeys = program.foreignUniforms;
        <span class="hljs-keyword">if</span> ( !foreignUniformKeys ) {
            <span class="hljs-keyword">this</span>._cacheUniformsForGeneratedProgram( program );
            foreignUniformKeys = program.foreignUniforms;
        }


        <span class="hljs-keyword">var</span> programUniformMap = program._uniformsCache;
        <span class="hljs-keyword">var</span> activeUniformMap = program.activeUniforms;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>apply active uniforms
caching uniforms from attribtues make it impossible to overwrite uniform with a custom uniform instance not used in the attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> i, l, name, location;
        <span class="hljs-keyword">var</span> activeUniformKeys = activeUniformMap.getKeys();

        <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>, l = activeUniformKeys.length; i &lt; l; i++ ) {

            name = activeUniformKeys[ i ];
            location = programUniformMap[ name ];
            activeUniformMap[ name ].apply( <span class="hljs-keyword">this</span>._graphicContext, location );

        }

        <span class="hljs-keyword">var</span> uniformMapStack = <span class="hljs-keyword">this</span>.uniforms;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>apply now foreign uniforms, it’s uniforms needed by the program but not contains in attributes used to generate this program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>, l = foreignUniformKeys.length; i &lt; l; i++ ) {

            name = foreignUniformKeys[ i ];
            <span class="hljs-keyword">var</span> uniformStack = uniformMapStack[ name ];
            location = programUniformMap[ name ];
            <span class="hljs-keyword">var</span> uniform;
            <span class="hljs-keyword">if</span> ( uniformStack !== <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">if</span> ( uniformStack.values().length === <span class="hljs-number">0</span> ) {
                    uniform = uniformStack.globalDefault;
                    Notify.warn( <span class="hljs-string">'Uniform Default Not attached to a StateSet in Scene Hierarchy: '</span> + uniformStack.globalDefault.getName() );
                } <span class="hljs-keyword">else</span> {
                    uniform = uniformStack.back().object;
                }

                uniform.apply( <span class="hljs-keyword">this</span>._graphicContext, location );
            }

        }
    }


} ), <span class="hljs-string">'osg'</span>, <span class="hljs-string">'State'</span> );

<span class="hljs-built_in">module</span>.exports = State;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
