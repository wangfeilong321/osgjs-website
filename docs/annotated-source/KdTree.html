<!DOCTYPE html>

<html>
<head>
  <title>KdTree.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="OSG.html">
                OSG.js
              </a>
            
              
              <a class="source" href="BillboardAttribute.html">
                BillboardAttribute.js
              </a>
            
              
              <a class="source" href="BlendColor.html">
                BlendColor.js
              </a>
            
              
              <a class="source" href="BlendFunc.html">
                BlendFunc.js
              </a>
            
              
              <a class="source" href="BoundingBox.html">
                BoundingBox.js
              </a>
            
              
              <a class="source" href="BoundingSphere.html">
                BoundingSphere.js
              </a>
            
              
              <a class="source" href="BufferArray.html">
                BufferArray.js
              </a>
            
              
              <a class="source" href="BufferArrayProxy.html">
                BufferArrayProxy.js
              </a>
            
              
              <a class="source" href="Camera.html">
                Camera.js
              </a>
            
              
              <a class="source" href="ColorMask.html">
                ColorMask.js
              </a>
            
              
              <a class="source" href="ComputeBoundsVisitor.html">
                ComputeBoundsVisitor.js
              </a>
            
              
              <a class="source" href="ComputeMatrixFromNodePath.html">
                ComputeMatrixFromNodePath.js
              </a>
            
              
              <a class="source" href="CullFace.html">
                CullFace.js
              </a>
            
              
              <a class="source" href="CullSettings.html">
                CullSettings.js
              </a>
            
              
              <a class="source" href="CullStack.html">
                CullStack.js
              </a>
            
              
              <a class="source" href="CullVisitor.html">
                CullVisitor.js
              </a>
            
              
              <a class="source" href="CullingSet.html">
                CullingSet.js
              </a>
            
              
              <a class="source" href="Depth.html">
                Depth.js
              </a>
            
              
              <a class="source" href="DrawArrayLengths.html">
                DrawArrayLengths.js
              </a>
            
              
              <a class="source" href="DrawArrays.html">
                DrawArrays.js
              </a>
            
              
              <a class="source" href="DrawElements.html">
                DrawElements.js
              </a>
            
              
              <a class="source" href="EllipsoidModel.html">
                EllipsoidModel.js
              </a>
            
              
              <a class="source" href="FrameBufferObject.html">
                FrameBufferObject.js
              </a>
            
              
              <a class="source" href="FrameStamp.html">
                FrameStamp.js
              </a>
            
              
              <a class="source" href="GLObject.html">
                GLObject.js
              </a>
            
              
              <a class="source" href="Geometry.html">
                Geometry.js
              </a>
            
              
              <a class="source" href="Image.html">
                Image.js
              </a>
            
              
              <a class="source" href="ImageStream.html">
                ImageStream.js
              </a>
            
              
              <a class="source" href="KdTree.html">
                KdTree.js
              </a>
            
              
              <a class="source" href="KdTreeBuilder.html">
                KdTreeBuilder.js
              </a>
            
              
              <a class="source" href="KdTreeRayIntersector.html">
                KdTreeRayIntersector.js
              </a>
            
              
              <a class="source" href="KdTreeSphereIntersector.html">
                KdTreeSphereIntersector.js
              </a>
            
              
              <a class="source" href="Light.html">
                Light.js
              </a>
            
              
              <a class="source" href="LightSource.html">
                LightSource.js
              </a>
            
              
              <a class="source" href="LineWidth.html">
                LineWidth.js
              </a>
            
              
              <a class="source" href="Lod.html">
                Lod.js
              </a>
            
              
              <a class="source" href="Map.html">
                Map.js
              </a>
            
              
              <a class="source" href="Material.html">
                Material.js
              </a>
            
              
              <a class="source" href="Math.html">
                Math.js
              </a>
            
              
              <a class="source" href="Matrix.html">
                Matrix.js
              </a>
            
              
              <a class="source" href="MatrixMemoryPool.html">
                MatrixMemoryPool.js
              </a>
            
              
              <a class="source" href="MatrixTransform.html">
                MatrixTransform.js
              </a>
            
              
              <a class="source" href="Node.html">
                Node.js
              </a>
            
              
              <a class="source" href="NodeVisitor.html">
                NodeVisitor.js
              </a>
            
              
              <a class="source" href="Notify.html">
                Notify.js
              </a>
            
              
              <a class="source" href="Object.html">
                Object.js
              </a>
            
              
              <a class="source" href="Options.html">
                Options.js
              </a>
            
              
              <a class="source" href="PagedLOD.html">
                PagedLOD.js
              </a>
            
              
              <a class="source" href="Plane.html">
                Plane.js
              </a>
            
              
              <a class="source" href="Polytope.html">
                Polytope.js
              </a>
            
              
              <a class="source" href="PrimitiveFunctor.html">
                PrimitiveFunctor.js
              </a>
            
              
              <a class="source" href="PrimitiveSet.html">
                PrimitiveSet.js
              </a>
            
              
              <a class="source" href="Program.html">
                Program.js
              </a>
            
              
              <a class="source" href="Projection.html">
                Projection.js
              </a>
            
              
              <a class="source" href="Quat.html">
                Quat.js
              </a>
            
              
              <a class="source" href="RenderBin.html">
                RenderBin.js
              </a>
            
              
              <a class="source" href="RenderLeaf.html">
                RenderLeaf.js
              </a>
            
              
              <a class="source" href="RenderStage.html">
                RenderStage.js
              </a>
            
              
              <a class="source" href="Shader.html">
                Shader.js
              </a>
            
              
              <a class="source" href="Shape.html">
                Shape.js
              </a>
            
              
              <a class="source" href="Stack.html">
                Stack.js
              </a>
            
              
              <a class="source" href="State.html">
                State.js
              </a>
            
              
              <a class="source" href="StateAttribute.html">
                StateAttribute.js
              </a>
            
              
              <a class="source" href="StateGraph.html">
                StateGraph.js
              </a>
            
              
              <a class="source" href="StateSet.html">
                StateSet.js
              </a>
            
              
              <a class="source" href="Texture.html">
                Texture.js
              </a>
            
              
              <a class="source" href="TextureCubeMap.html">
                TextureCubeMap.js
              </a>
            
              
              <a class="source" href="TextureManager.html">
                TextureManager.js
              </a>
            
              
              <a class="source" href="Timer.html">
                Timer.js
              </a>
            
              
              <a class="source" href="Transform.html">
                Transform.js
              </a>
            
              
              <a class="source" href="TransformEnums.html">
                TransformEnums.js
              </a>
            
              
              <a class="source" href="TriangleIndexFunctor.html">
                TriangleIndexFunctor.js
              </a>
            
              
              <a class="source" href="Uniform.html">
                Uniform.js
              </a>
            
              
              <a class="source" href="UpdateVisitor.html">
                UpdateVisitor.js
              </a>
            
              
              <a class="source" href="Utils.html">
                Utils.js
              </a>
            
              
              <a class="source" href="Vec2.html">
                Vec2.js
              </a>
            
              
              <a class="source" href="Vec3.html">
                Vec3.js
              </a>
            
              
              <a class="source" href="Vec4.html">
                Vec4.js
              </a>
            
              
              <a class="source" href="Viewport.html">
                Viewport.js
              </a>
            
              
              <a class="source" href="WebGLCaps.html">
                WebGLCaps.js
              </a>
            
              
              <a class="source" href="osg.html">
                osg.js
              </a>
            
              
              <a class="source" href="Animation.html">
                Animation.js
              </a>
            
              
              <a class="source" href="AnimationUpdateCallback.html">
                AnimationUpdateCallback.js
              </a>
            
              
              <a class="source" href="BasicAnimationManager.html">
                BasicAnimationManager.js
              </a>
            
              
              <a class="source" href="Bone.html">
                Bone.js
              </a>
            
              
              <a class="source" href="Channel.html">
                Channel.js
              </a>
            
              
              <a class="source" href="CollectAnimationUpdateCallbackVisitor.html">
                CollectAnimationUpdateCallbackVisitor.js
              </a>
            
              
              <a class="source" href="CollectBoneVisitor.html">
                CollectBoneVisitor.js
              </a>
            
              
              <a class="source" href="Easing.html">
                Easing.js
              </a>
            
              
              <a class="source" href="FindNearestParentSkeleton.html">
                FindNearestParentSkeleton.js
              </a>
            
              
              <a class="source" href="Interpolator.html">
                Interpolator.js
              </a>
            
              
              <a class="source" href="MorphAttribute.html">
                MorphAttribute.js
              </a>
            
              
              <a class="source" href="MorphGeometry.html">
                MorphGeometry.js
              </a>
            
              
              <a class="source" href="RigGeometry.html">
                RigGeometry.js
              </a>
            
              
              <a class="source" href="RigTransformHardware.html">
                RigTransformHardware.js
              </a>
            
              
              <a class="source" href="Skeleton.html">
                Skeleton.js
              </a>
            
              
              <a class="source" href="SkinningAttribute.html">
                SkinningAttribute.js
              </a>
            
              
              <a class="source" href="StackedMatrix.html">
                StackedMatrix.js
              </a>
            
              
              <a class="source" href="StackedQuaternion.html">
                StackedQuaternion.js
              </a>
            
              
              <a class="source" href="StackedRotateAxis.html">
                StackedRotateAxis.js
              </a>
            
              
              <a class="source" href="StackedScale.html">
                StackedScale.js
              </a>
            
              
              <a class="source" href="StackedTranslate.html">
                StackedTranslate.js
              </a>
            
              
              <a class="source" href="Target.html">
                Target.js
              </a>
            
              
              <a class="source" href="UpdateBone.html">
                UpdateBone.js
              </a>
            
              
              <a class="source" href="UpdateMatrixTransform.html">
                UpdateMatrixTransform.js
              </a>
            
              
              <a class="source" href="UpdateMorph.html">
                UpdateMorph.js
              </a>
            
              
              <a class="source" href="UpdateRigGeometry.html">
                UpdateRigGeometry.js
              </a>
            
              
              <a class="source" href="UpdateSkeleton.html">
                UpdateSkeleton.js
              </a>
            
              
              <a class="source" href="channelType.html">
                channelType.js
              </a>
            
              
              <a class="source" href="osgAnimation.html">
                osgAnimation.js
              </a>
            
              
              <a class="source" href="DatabasePager.html">
                DatabasePager.js
              </a>
            
              
              <a class="source" href="Input.html">
                Input.js
              </a>
            
              
              <a class="source" href="Options.html">
                Options.js
              </a>
            
              
              <a class="source" href="ReaderParser.html">
                ReaderParser.js
              </a>
            
              
              <a class="source" href="osgDB.html">
                osgDB.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulator.html">
                FirstPersonManipulator.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorDeviceOrientationController.html">
                FirstPersonManipulatorDeviceOrientationController.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorHammerController.html">
                FirstPersonManipulatorHammerController.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorStandardMouseKeyboardController.html">
                FirstPersonManipulatorStandardMouseKeyboardController.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorWebVRController.html">
                FirstPersonManipulatorWebVRController.js
              </a>
            
              
              <a class="source" href="Manipulator.html">
                Manipulator.js
              </a>
            
              
              <a class="source" href="OrbitManipulator.html">
                OrbitManipulator.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorDeviceOrientationController.html">
                OrbitManipulatorDeviceOrientationController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorEnums.html">
                OrbitManipulatorEnums.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorGamePadController.html">
                OrbitManipulatorGamePadController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorHammerController.html">
                OrbitManipulatorHammerController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorLeapMotionController.html">
                OrbitManipulatorLeapMotionController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorStandardMouseKeyboardController.html">
                OrbitManipulatorStandardMouseKeyboardController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorWebVRController.html">
                OrbitManipulatorWebVRController.js
              </a>
            
              
              <a class="source" href="SwitchManipulator.html">
                SwitchManipulator.js
              </a>
            
              
              <a class="source" href="osgGA.html">
                osgGA.js
              </a>
            
              
              <a class="source" href="osgNameSpace.html">
                osgNameSpace.js
              </a>
            
              
              <a class="source" href="Compiler.html">
                Compiler.js
              </a>
            
              
              <a class="source" href="ShaderGenerator.html">
                ShaderGenerator.js
              </a>
            
              
              <a class="source" href="ShaderGeneratorProxy.html">
                ShaderGeneratorProxy.js
              </a>
            
              
              <a class="source" href="ShaderProcessor.html">
                ShaderProcessor.js
              </a>
            
              
              <a class="source" href="node.html">
                node.js
              </a>
            
              
              <a class="source" href="Node.html">
                Node.js
              </a>
            
              
              <a class="source" href="data.html">
                data.js
              </a>
            
              
              <a class="source" href="functions.html">
                functions.js
              </a>
            
              
              <a class="source" href="lights.html">
                lights.js
              </a>
            
              
              <a class="source" href="morph.html">
                morph.js
              </a>
            
              
              <a class="source" href="operations.html">
                operations.js
              </a>
            
              
              <a class="source" href="shadows.html">
                shadows.js
              </a>
            
              
              <a class="source" href="skinning.html">
                skinning.js
              </a>
            
              
              <a class="source" href="textures.html">
                textures.js
              </a>
            
              
              <a class="source" href="nodeFactory.html">
                nodeFactory.js
              </a>
            
              
              <a class="source" href="osgShader.html">
                osgShader.js
              </a>
            
              
              <a class="source" href="shaderLib.html">
                shaderLib.js
              </a>
            
              
              <a class="source" href="utils.html">
                utils.js
              </a>
            
              
              <a class="source" href="ShadowCastAttribute.html">
                ShadowCastAttribute.js
              </a>
            
              
              <a class="source" href="ShadowCastCompiler.html">
                ShadowCastCompiler.js
              </a>
            
              
              <a class="source" href="ShadowCastShaderGenerator.html">
                ShadowCastShaderGenerator.js
              </a>
            
              
              <a class="source" href="ShadowCasterVisitor.html">
                ShadowCasterVisitor.js
              </a>
            
              
              <a class="source" href="ShadowFrustumIntersection.html">
                ShadowFrustumIntersection.js
              </a>
            
              
              <a class="source" href="ShadowMap.html">
                ShadowMap.js
              </a>
            
              
              <a class="source" href="ShadowReceiveAttribute.html">
                ShadowReceiveAttribute.js
              </a>
            
              
              <a class="source" href="ShadowSettings.html">
                ShadowSettings.js
              </a>
            
              
              <a class="source" href="ShadowTechnique.html">
                ShadowTechnique.js
              </a>
            
              
              <a class="source" href="ShadowTexture.html">
                ShadowTexture.js
              </a>
            
              
              <a class="source" href="ShadowedScene.html">
                ShadowedScene.js
              </a>
            
              
              <a class="source" href="osgShadow.html">
                osgShadow.js
              </a>
            
              
              <a class="source" href="shaderLib.html">
                shaderLib.js
              </a>
            
              
              <a class="source" href="Text.html">
                Text.js
              </a>
            
              
              <a class="source" href="osgText.html">
                osgText.js
              </a>
            
              
              <a class="source" href="Composer.html">
                Composer.js
              </a>
            
              
              <a class="source" href="DisplayGeometryVisitor.html">
                DisplayGeometryVisitor.js
              </a>
            
              
              <a class="source" href="DisplayGraph.html">
                DisplayGraph.js
              </a>
            
              
              <a class="source" href="DisplayGraphNode.html">
                DisplayGraphNode.js
              </a>
            
              
              <a class="source" href="DisplayGraphRenderer.html">
                DisplayGraphRenderer.js
              </a>
            
              
              <a class="source" href="DisplayNormalVisitor.html">
                DisplayNormalVisitor.js
              </a>
            
              
              <a class="source" href="GizmoGeometry.html">
                GizmoGeometry.js
              </a>
            
              
              <a class="source" href="IntersectionVisitor.html">
                IntersectionVisitor.js
              </a>
            
              
              <a class="source" href="LineSegmentIntersector.html">
                LineSegmentIntersector.js
              </a>
            
              
              <a class="source" href="NodeGizmo.html">
                NodeGizmo.js
              </a>
            
              
              <a class="source" href="ParameterVisitor.html">
                ParameterVisitor.js
              </a>
            
              
              <a class="source" href="PolytopeIntersector.html">
                PolytopeIntersector.js
              </a>
            
              
              <a class="source" href="PolytopePrimitiveIntersector.html">
                PolytopePrimitiveIntersector.js
              </a>
            
              
              <a class="source" href="SphereIntersector.html">
                SphereIntersector.js
              </a>
            
              
              <a class="source" href="TangentSpaceGenerator.html">
                TangentSpaceGenerator.js
              </a>
            
              
              <a class="source" href="TriangleIntersector.html">
                TriangleIntersector.js
              </a>
            
              
              <a class="source" href="TriangleSphereIntersector.html">
                TriangleSphereIntersector.js
              </a>
            
              
              <a class="source" href="WebVR.html">
                WebVR.js
              </a>
            
              
              <a class="source" href="WebVRCustom.html">
                WebVRCustom.js
              </a>
            
              
              <a class="source" href="osgPool.html">
                osgPool.js
              </a>
            
              
              <a class="source" href="osgUtil.html">
                osgUtil.js
              </a>
            
              
              <a class="source" href="Renderer.html">
                Renderer.js
              </a>
            
              
              <a class="source" href="Scene.html">
                Scene.js
              </a>
            
              
              <a class="source" href="View.html">
                View.js
              </a>
            
              
              <a class="source" href="Viewer.html">
                Viewer.js
              </a>
            
              
              <a class="source" href="createStats.html">
                createStats.js
              </a>
            
              
              <a class="source" href="DeviceOrientation.html">
                DeviceOrientation.js
              </a>
            
              
              <a class="source" href="EventProxy.html">
                EventProxy.js
              </a>
            
              
              <a class="source" href="GamePad.html">
                GamePad.js
              </a>
            
              
              <a class="source" href="Hammer.html">
                Hammer.js
              </a>
            
              
              <a class="source" href="LeapMotion.html">
                LeapMotion.js
              </a>
            
              
              <a class="source" href="StandardMouseKeyboard.html">
                StandardMouseKeyboard.js
              </a>
            
              
              <a class="source" href="WebVR.html">
                WebVR.js
              </a>
            
              
              <a class="source" href="osgViewer.html">
                osgViewer.js
              </a>
            
              
              <a class="source" href="webgl-debug.html">
                webgl-debug.js
              </a>
            
              
              <a class="source" href="webgl-utils.html">
                webgl-utils.js
              </a>
            
              
              <a class="source" href="osgWrappers.html">
                osgWrappers.js
              </a>
            
              
              <a class="source" href="osg.html">
                osg.js
              </a>
            
              
              <a class="source" href="osgAnimation.html">
                osgAnimation.js
              </a>
            
              
              <a class="source" href="osgText.html">
                osgText.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>KdTree.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">var</span> MACROUTILS = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Utils'</span> );
<span class="hljs-keyword">var</span> Vec3 = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/Vec3'</span> );
<span class="hljs-keyword">var</span> BoundingBox = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/BoundingBox'</span> );
<span class="hljs-keyword">var</span> TriangleIndexFunctor = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/TriangleIndexFunctor'</span> );
<span class="hljs-keyword">var</span> PrimitiveSet = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/PrimitiveSet'</span> );
<span class="hljs-keyword">var</span> KdTreeRayIntersector = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/KdTreeRayIntersector'</span> );
<span class="hljs-keyword">var</span> KdTreeSphereIntersector = <span class="hljs-built_in">require</span>( <span class="hljs-string">'osg/KdTreeSphereIntersector'</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong><strong> GENERAL INFO ON KDTREE </strong></strong>
A KdTree is a Spatial Partitionning Tree (<a href="http://en.wikipedia.org/wiki/Space_partitioning">http://en.wikipedia.org/wiki/Space_partitioning</a>)
The type of tree is sort of defined by the splitting axis method:</p>
<ul>
<li>Per Axis split (octree/ kdtree)</li>
<li>Arbritrary direction split (bsp)</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The algorithm used for splitting, the name for finding best split is ‘Surface Area Heuristic (SAH)’
Octree divide the space in 8 subspace (one box -&gt; 8 sub boxes)
whereas kdtree does it by splitting population number in two equal group</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Kd Tree <a href="http://en.wikipedia.org/wiki/K-d_tree">http://en.wikipedia.org/wiki/K-d_tree</a>
a given set of points is sorted along one Axis (e.g. X).
The sorted list is split at the median.
The result are two sets, one for each half-space (left and right).</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Then, for the current node, the splitting-plane position (or the median-point) and depth is saved.
Finally, if the point-set has more than n point and the tree depth is below m
(with n,m chosen by the user, as build options), two child-nodes (L/R one for each point-set)
are created which themselfs repeat the pocedure.</p>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The split-axis gets alternated at each depth, the split order is computed by checking the main
bounding box the length of its axis
<strong><strong> GENERAL INFO ON KDTREE </strong></strong></p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The KdTree implemented here is flattened, ie, a node and its children all lie in the same array
The most important thing is the understanding of the variables first and second for each node
Their semantic depend if the node is a leaf or not
if it’s a leaf :
  first and second defines a range in the triangles array (triangles in the cell)
if it’s not a leaf :</p>
<ul>
<li>first and second respectively represents the left and right sub children
We know that a node is a leaf if first is negative, in that case the range will be defined by
[ -first - 1, -first-1 + second ]</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> KdNode = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> first, second </span>) </span>{
    <span class="hljs-keyword">this</span>._bb = <span class="hljs-keyword">new</span> BoundingBox();
    <span class="hljs-keyword">this</span>._first = first;
    <span class="hljs-keyword">this</span>._second = second;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>These variables represent the local clipped ray (for intersection test)
They are mostly temporary because they are recomputed for each intersection test</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._nodeRayStart = Vec3.create();
    <span class="hljs-keyword">this</span>._nodeRayEnd = Vec3.create();
};

<span class="hljs-keyword">var</span> BuildKdTree = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> kdTree </span>) </span>{
    <span class="hljs-keyword">this</span>._kdTree = kdTree;
    <span class="hljs-keyword">this</span>._bb = <span class="hljs-keyword">new</span> BoundingBox();
    <span class="hljs-keyword">this</span>._primitiveIndices = <span class="hljs-literal">null</span>; <span class="hljs-comment">// Uint32Array</span>
    <span class="hljs-keyword">this</span>._centers = <span class="hljs-literal">null</span>; <span class="hljs-comment">// Float32Array</span>
    <span class="hljs-keyword">this</span>._axisOrder = Vec3.create();
    <span class="hljs-keyword">this</span>._stackLength = <span class="hljs-number">0</span>;
};

BuildKdTree.prototype = {
    build: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> options, geom </span>) </span>{
        <span class="hljs-keyword">var</span> targetTris = options._targetNumTrianglesPerLeaf;
        <span class="hljs-keyword">var</span> vertexAttrib = geom.getVertexAttributeList().Vertex;
        <span class="hljs-keyword">if</span> ( !vertexAttrib )
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">var</span> vertices = vertexAttrib.getElements();
        <span class="hljs-keyword">if</span> ( !vertices )
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">var</span> nbVertices = vertices.length / <span class="hljs-number">3</span>;
        <span class="hljs-keyword">if</span> ( nbVertices &lt; targetTris )
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">this</span>._bb.copy( geom.getBoundingBox() );
        <span class="hljs-keyword">this</span>._kdTree.setVertices( vertices );

        <span class="hljs-keyword">this</span>.computeDivisions( options );
        options._numVerticesProcessed += nbVertices;

        <span class="hljs-keyword">this</span>.computeTriangles( geom );

        <span class="hljs-keyword">var</span> node = <span class="hljs-keyword">new</span> KdNode( <span class="hljs-number">-1</span>, <span class="hljs-keyword">this</span>._primitiveIndices.length );
        node._bb.copy( <span class="hljs-keyword">this</span>._bb );
        <span class="hljs-keyword">var</span> nodeNum = <span class="hljs-keyword">this</span>._kdTree.addNode( node );

        <span class="hljs-keyword">var</span> bb = <span class="hljs-keyword">new</span> BoundingBox();
        bb.copy( <span class="hljs-keyword">this</span>._bb );
        nodeNum = <span class="hljs-keyword">this</span>.divide( options, bb, nodeNum, <span class="hljs-number">0</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Here we re-order the triangle list so that we can have a flat tree
_primitiveIndices is the ordered array of the triangle indices</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> triangles = <span class="hljs-keyword">this</span>._kdTree.getTriangles();
        <span class="hljs-keyword">var</span> primitives = <span class="hljs-keyword">this</span>._primitiveIndices;
        <span class="hljs-keyword">var</span> nbPrimitives = primitives.length;
        <span class="hljs-keyword">var</span> triangleOrdered = <span class="hljs-keyword">new</span> MACROUTILS.Uint32Array( triangles.length );
        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; nbPrimitives; ++i, j += <span class="hljs-number">3</span> ) {
            <span class="hljs-keyword">var</span> id = primitives[ i ] * <span class="hljs-number">3</span>;
            triangleOrdered[ j ] = triangles[ id ];
            triangleOrdered[ j + <span class="hljs-number">1</span> ] = triangles[ id + <span class="hljs-number">1</span> ];
            triangleOrdered[ j + <span class="hljs-number">2</span> ] = triangles[ id + <span class="hljs-number">2</span> ];
        }
        <span class="hljs-keyword">this</span>._kdTree.setTriangles( triangleOrdered );
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._kdTree.getNodes().length &gt; <span class="hljs-number">0</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The function first gather all the triangles of the geometry
It then computes the centroid for each triangle and initialize
of triangles indices that will refer to the main triangles array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    computeTriangles: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> geom </span>) </span>{
        <span class="hljs-keyword">var</span> kdTree = <span class="hljs-keyword">this</span>._kdTree;

        <span class="hljs-keyword">var</span> totalLenArray = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> geomPrimitives = geom.primitives;
        <span class="hljs-keyword">var</span> nbPrimitives = geomPrimitives.length;
        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; nbPrimitives; i++ ) {
            <span class="hljs-keyword">var</span> prim = geomPrimitives[ i ];
            <span class="hljs-keyword">var</span> mode = prim.getMode();</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>ignore points and line stuffs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( mode === PrimitiveSet.TRIANGLES )
                totalLenArray += prim.getCount();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( mode === PrimitiveSet.TRIANGLE_STRIP || mode === PrimitiveSet.TRIANGLE_FAN )
                totalLenArray += ( prim.getCount() - <span class="hljs-number">2</span> ) * <span class="hljs-number">3</span>;
        }
        <span class="hljs-keyword">var</span> indices = <span class="hljs-keyword">new</span> MACROUTILS.Uint32Array( totalLenArray );
        <span class="hljs-keyword">var</span> next = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> cb = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> i1, i2, i3 </span>) </span>{
            <span class="hljs-keyword">if</span> ( i1 === i2 || i1 === i3 || i2 === i3 )
                <span class="hljs-keyword">return</span>;
            indices[ next ] = i1;
            indices[ next + <span class="hljs-number">1</span> ] = i2;
            indices[ next + <span class="hljs-number">2</span> ] = i3;
            next += <span class="hljs-number">3</span>;
        };


        <span class="hljs-keyword">var</span> tif = <span class="hljs-keyword">new</span> TriangleIndexFunctor();
        tif.init( geom, cb );
        tif.apply();

        indices = indices.subarray( <span class="hljs-number">0</span>, next );

        <span class="hljs-keyword">var</span> nbTriangles = indices.length;
        kdTree.setTriangles( indices );

        <span class="hljs-keyword">var</span> vertices = kdTree.getVertices();

        <span class="hljs-keyword">this</span>._centers = <span class="hljs-keyword">new</span> MACROUTILS.Float32Array( nbTriangles );
        <span class="hljs-keyword">var</span> centers = <span class="hljs-keyword">this</span>._centers;
        <span class="hljs-keyword">this</span>._primitiveIndices = <span class="hljs-keyword">new</span> MACROUTILS.Uint32Array( nbTriangles / <span class="hljs-number">3</span> );
        <span class="hljs-keyword">var</span> primitives = <span class="hljs-keyword">this</span>._primitiveIndices;

        <span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; nbTriangles; i += <span class="hljs-number">3</span>, ++j ) {
            <span class="hljs-keyword">var</span> iv0 = indices[ i ];
            <span class="hljs-keyword">var</span> iv1 = indices[ i + <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">var</span> iv2 = indices[ i + <span class="hljs-number">2</span> ];</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>discard degenerate points</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ( iv0 === iv1 || iv1 === iv2 || iv0 === iv2 )
                <span class="hljs-keyword">return</span>;

            iv0 *= <span class="hljs-number">3</span>;
            iv1 *= <span class="hljs-number">3</span>;
            iv2 *= <span class="hljs-number">3</span>;

            <span class="hljs-keyword">var</span> v0x = vertices[ iv0 ];
            <span class="hljs-keyword">var</span> v0y = vertices[ iv0 + <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">var</span> v0z = vertices[ iv0 + <span class="hljs-number">2</span> ];

            <span class="hljs-keyword">var</span> v1x = vertices[ iv1 ];
            <span class="hljs-keyword">var</span> v1y = vertices[ iv1 + <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">var</span> v1z = vertices[ iv1 + <span class="hljs-number">2</span> ];

            <span class="hljs-keyword">var</span> v2x = vertices[ iv2 ];
            <span class="hljs-keyword">var</span> v2y = vertices[ iv2 + <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">var</span> v2z = vertices[ iv2 + <span class="hljs-number">2</span> ];

            <span class="hljs-keyword">var</span> minx = <span class="hljs-built_in">Math</span>.min( v0x, <span class="hljs-built_in">Math</span>.min( v1x, v2x ) );
            <span class="hljs-keyword">var</span> miny = <span class="hljs-built_in">Math</span>.min( v0y, <span class="hljs-built_in">Math</span>.min( v1y, v2y ) );
            <span class="hljs-keyword">var</span> minz = <span class="hljs-built_in">Math</span>.min( v0z, <span class="hljs-built_in">Math</span>.min( v1z, v2z ) );

            <span class="hljs-keyword">var</span> maxx = <span class="hljs-built_in">Math</span>.max( v0x, <span class="hljs-built_in">Math</span>.max( v1x, v2x ) );
            <span class="hljs-keyword">var</span> maxy = <span class="hljs-built_in">Math</span>.max( v0y, <span class="hljs-built_in">Math</span>.max( v1y, v2y ) );
            <span class="hljs-keyword">var</span> maxz = <span class="hljs-built_in">Math</span>.max( v0z, <span class="hljs-built_in">Math</span>.max( v1z, v2z ) );
            centers[ i ] = ( minx + maxx ) * <span class="hljs-number">0.5</span>;
            centers[ i + <span class="hljs-number">1</span> ] = ( miny + maxy ) * <span class="hljs-number">0.5</span>;
            centers[ i + <span class="hljs-number">2</span> ] = ( minz + maxz ) * <span class="hljs-number">0.5</span>;
            primitives[ j ] = j;
        }
    },
    computeDivisions: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> options </span>) </span>{
        <span class="hljs-keyword">this</span>._stackLength = options._maxNumLevels;
        <span class="hljs-keyword">var</span> max = <span class="hljs-keyword">this</span>._bb._max;
        <span class="hljs-keyword">var</span> min = <span class="hljs-keyword">this</span>._bb._min;
        <span class="hljs-keyword">var</span> dx = max[ <span class="hljs-number">0</span> ] - min[ <span class="hljs-number">0</span> ];
        <span class="hljs-keyword">var</span> dy = max[ <span class="hljs-number">1</span> ] - min[ <span class="hljs-number">1</span> ];
        <span class="hljs-keyword">var</span> dz = max[ <span class="hljs-number">2</span> ] - min[ <span class="hljs-number">2</span> ];
        <span class="hljs-keyword">var</span> axisOrder = <span class="hljs-keyword">this</span>._axisOrder;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>We set the cutting order (longest edge aabb first)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        axisOrder[ <span class="hljs-number">0</span> ] = ( dx &gt;= dy &amp;&amp; dx &gt;= dz ) ? <span class="hljs-number">0</span> : ( dy &gt;= dz ) ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>;
        axisOrder[ <span class="hljs-number">2</span> ] = ( dx &lt; dy &amp;&amp; dx &lt; dz ) ? <span class="hljs-number">0</span> : ( dy &lt; dz ) ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>;
        <span class="hljs-keyword">var</span> sum = axisOrder[ <span class="hljs-number">0</span> ] + axisOrder[ <span class="hljs-number">2</span> ];
        axisOrder[ <span class="hljs-number">1</span> ] = sum === <span class="hljs-number">3</span> ? <span class="hljs-number">0</span> : sum === <span class="hljs-number">2</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">2</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>The core function of the kdtree building
It checks if the node need to be subdivide or not
If it decides it’s a leaf, it computes the final bounding box of the node
and it ends here
If it’s a node, then it puts the splitting axis position on the median population
On the same time it reorder the triangle index array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    divide: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> options, bb, nodeIndex, level </span>) </span>{
        <span class="hljs-keyword">var</span> kdTree = <span class="hljs-keyword">this</span>._kdTree;
        <span class="hljs-keyword">var</span> primitives = <span class="hljs-keyword">this</span>._primitiveIndices;
        <span class="hljs-keyword">var</span> nodes = kdTree.getNodes();
        <span class="hljs-keyword">var</span> node = nodes[ nodeIndex ];

        <span class="hljs-keyword">var</span> first = node._first;
        <span class="hljs-keyword">var</span> second = node._second;

        <span class="hljs-keyword">var</span> needToDivide = level &lt; <span class="hljs-keyword">this</span>._stackLength &amp;&amp; first &lt; <span class="hljs-number">0</span> &amp;&amp; second &gt; options._targetNumTrianglesPerLeaf;
        <span class="hljs-keyword">var</span> istart = -first - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">var</span> iend = istart + second - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> ( !needToDivide ) {
            <span class="hljs-keyword">if</span> ( first &lt; <span class="hljs-number">0</span> ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>leaf is done, now compute bound on it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>.computeNodeBox( node, istart, iend );
            }
            <span class="hljs-keyword">return</span> nodeIndex;
        }

        <span class="hljs-keyword">if</span> ( first &gt;= <span class="hljs-number">0</span> )
            <span class="hljs-keyword">return</span> nodeIndex;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>leaf node as first &lt; 0, so look at dividing it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        <span class="hljs-keyword">var</span> axis = <span class="hljs-keyword">this</span>._axisOrder[ level % <span class="hljs-number">3</span> ];
        <span class="hljs-keyword">var</span> originalMin = bb._min[ axis ];
        <span class="hljs-keyword">var</span> originalMax = bb._max[ axis ];

        <span class="hljs-keyword">var</span> mid = ( originalMin + originalMax ) * <span class="hljs-number">0.5</span>;

        <span class="hljs-keyword">var</span> originalLeftChildIndex = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> originalRightChildIndex = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> insitueDivision = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">var</span> left = istart;
        <span class="hljs-keyword">var</span> right = iend;

        <span class="hljs-keyword">var</span> centers = <span class="hljs-keyword">this</span>._centers;
        <span class="hljs-keyword">while</span> ( left &lt; right ) {
            <span class="hljs-keyword">while</span> ( left &lt; right &amp;&amp; ( centers[ primitives[ left ] * <span class="hljs-number">3</span> + axis ] &lt;= mid ) ) {
                ++left;
            }

            <span class="hljs-keyword">while</span> ( left &lt; right &amp;&amp; ( centers[ primitives[ right ] * <span class="hljs-number">3</span> + axis ] &gt; mid ) ) {
                --right;
            }

            <span class="hljs-keyword">if</span> ( left &lt; right ) {
                <span class="hljs-keyword">var</span> tmp = primitives[ left ];
                primitives[ left ] = primitives[ right ];
                primitives[ right ] = tmp;
                ++left;
                --right;
            }
        }

        <span class="hljs-keyword">if</span> ( left === right ) {
            <span class="hljs-keyword">if</span> ( centers[ primitives[ left ] * <span class="hljs-number">3</span> + axis ] &lt;= mid ) ++left;
            <span class="hljs-keyword">else</span> --right;
        }

        <span class="hljs-keyword">if</span> ( ( right - istart ) &lt;= <span class="hljs-number">-1</span> ) {
            originalLeftChildIndex = <span class="hljs-number">0</span>;
            originalRightChildIndex = nodeIndex;
            insitueDivision = <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( ( iend - left ) &lt;= <span class="hljs-number">-1</span> ) {
            originalLeftChildIndex = nodeIndex;
            originalRightChildIndex = <span class="hljs-number">0</span>;
            insitueDivision = <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> {
            originalLeftChildIndex = kdTree.addNode( <span class="hljs-keyword">new</span> KdNode( -istart - <span class="hljs-number">1</span>, ( right - istart ) + <span class="hljs-number">1</span> ) );
            originalRightChildIndex = kdTree.addNode( <span class="hljs-keyword">new</span> KdNode( -left - <span class="hljs-number">1</span>, ( iend - left ) + <span class="hljs-number">1</span> ) );
        }


        <span class="hljs-keyword">var</span> restore = bb._max[ axis ];
        bb._max[ axis ] = mid;

        <span class="hljs-keyword">var</span> leftChildIndex = originalLeftChildIndex !== <span class="hljs-number">0</span> ? <span class="hljs-keyword">this</span>.divide( options, bb, originalLeftChildIndex, level + <span class="hljs-number">1</span> ) : <span class="hljs-number">0</span>;

        bb._max[ axis ] = restore;

        restore = bb._min[ axis ];
        bb._min[ axis ] = mid;

        <span class="hljs-keyword">var</span> rightChildIndex = originalRightChildIndex !== <span class="hljs-number">0</span> ? <span class="hljs-keyword">this</span>.divide( options, bb, originalRightChildIndex, level + <span class="hljs-number">1</span> ) : <span class="hljs-number">0</span>;

        bb._min[ axis ] = restore;

        <span class="hljs-keyword">if</span> ( !insitueDivision ) {
            node._first = leftChildIndex;
            node._second = rightChildIndex;

            insitueDivision = <span class="hljs-literal">true</span>;

            <span class="hljs-keyword">var</span> bnode = node._bb;
            bnode.init();
            <span class="hljs-keyword">if</span> ( leftChildIndex !== <span class="hljs-number">0</span> ) bnode.expandByBoundingBox( nodes[ leftChildIndex ]._bb );
            <span class="hljs-keyword">if</span> ( rightChildIndex !== <span class="hljs-number">0</span> ) bnode.expandByBoundingBox( nodes[ rightChildIndex ]._bb );
        }
        <span class="hljs-keyword">return</span> nodeIndex;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>It computes the bounding box of the node so that the box contains all the triangles
of the cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    computeNodeBox: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> node, istart, iend </span>) </span>{
        <span class="hljs-keyword">var</span> minx = <span class="hljs-literal">Infinity</span>,
            miny = <span class="hljs-literal">Infinity</span>,
            minz = <span class="hljs-literal">Infinity</span>,
            maxx = -<span class="hljs-literal">Infinity</span>,
            maxy = -<span class="hljs-literal">Infinity</span>,
            maxz = -<span class="hljs-literal">Infinity</span>;
        <span class="hljs-keyword">var</span> triangles = <span class="hljs-keyword">this</span>._kdTree.getTriangles();
        <span class="hljs-keyword">var</span> vertices = <span class="hljs-keyword">this</span>._kdTree.getVertices();
        <span class="hljs-keyword">var</span> primitives = <span class="hljs-keyword">this</span>._primitiveIndices;
        <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = istart; i &lt;= iend; ++i ) {
            <span class="hljs-keyword">var</span> id = primitives[ i ] * <span class="hljs-number">3</span>;
            <span class="hljs-keyword">var</span> iv0 = triangles[ id ] * <span class="hljs-number">3</span>;
            <span class="hljs-keyword">var</span> iv1 = triangles[ id + <span class="hljs-number">1</span> ] * <span class="hljs-number">3</span>;
            <span class="hljs-keyword">var</span> iv2 = triangles[ id + <span class="hljs-number">2</span> ] * <span class="hljs-number">3</span>;

            <span class="hljs-keyword">var</span> v0x = vertices[ iv0 ];
            <span class="hljs-keyword">var</span> v0y = vertices[ iv0 + <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">var</span> v0z = vertices[ iv0 + <span class="hljs-number">2</span> ];

            <span class="hljs-keyword">var</span> v1x = vertices[ iv1 ];
            <span class="hljs-keyword">var</span> v1y = vertices[ iv1 + <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">var</span> v1z = vertices[ iv1 + <span class="hljs-number">2</span> ];

            <span class="hljs-keyword">var</span> v2x = vertices[ iv2 ];
            <span class="hljs-keyword">var</span> v2y = vertices[ iv2 + <span class="hljs-number">1</span> ];
            <span class="hljs-keyword">var</span> v2z = vertices[ iv2 + <span class="hljs-number">2</span> ];

            minx = <span class="hljs-built_in">Math</span>.min( minx, <span class="hljs-built_in">Math</span>.min( v0x, <span class="hljs-built_in">Math</span>.min( v1x, v2x ) ) );
            miny = <span class="hljs-built_in">Math</span>.min( miny, <span class="hljs-built_in">Math</span>.min( v0y, <span class="hljs-built_in">Math</span>.min( v1y, v2y ) ) );
            minz = <span class="hljs-built_in">Math</span>.min( minz, <span class="hljs-built_in">Math</span>.min( v0z, <span class="hljs-built_in">Math</span>.min( v1z, v2z ) ) );

            maxx = <span class="hljs-built_in">Math</span>.max( maxx, <span class="hljs-built_in">Math</span>.max( v0x, <span class="hljs-built_in">Math</span>.max( v1x, v2x ) ) );
            maxy = <span class="hljs-built_in">Math</span>.max( maxy, <span class="hljs-built_in">Math</span>.max( v0y, <span class="hljs-built_in">Math</span>.max( v1y, v2y ) ) );
            maxz = <span class="hljs-built_in">Math</span>.max( maxz, <span class="hljs-built_in">Math</span>.max( v0z, <span class="hljs-built_in">Math</span>.max( v1z, v2z ) ) );
        }
        <span class="hljs-keyword">var</span> epsilon = <span class="hljs-number">1E-6</span>;
        <span class="hljs-keyword">var</span> bnode = node._bb;
        <span class="hljs-keyword">var</span> bmin = bnode._min;
        <span class="hljs-keyword">var</span> bmax = bnode._max;
        bmin[ <span class="hljs-number">0</span> ] = minx - epsilon;
        bmin[ <span class="hljs-number">1</span> ] = miny - epsilon;
        bmin[ <span class="hljs-number">2</span> ] = minz - epsilon;
        bmax[ <span class="hljs-number">0</span> ] = maxx + epsilon;
        bmax[ <span class="hljs-number">1</span> ] = maxy + epsilon;
        bmax[ <span class="hljs-number">2</span> ] = maxz + epsilon;
    }
};

<span class="hljs-keyword">var</span> KdTree = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._vertices = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>._kdNodes = [];
    <span class="hljs-keyword">this</span>._triangles = <span class="hljs-literal">null</span>; <span class="hljs-comment">// Float32Array</span>
};

KdTree.prototype = MACROUTILS.objectLibraryClass( {
    getVertices: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._vertices;
    },
    setVertices: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> vertices </span>) </span>{
        <span class="hljs-keyword">this</span>._vertices = vertices;
    },
    getNodes: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._kdNodes;
    },
    getTriangles: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._triangles;
    },
    setTriangles: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> triangles </span>) </span>{
        <span class="hljs-keyword">this</span>._triangles = triangles;
    },
    addNode: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> node </span>) </span>{
        <span class="hljs-keyword">this</span>._kdNodes.push( node );
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._kdNodes.length - <span class="hljs-number">1</span>;
    },
    build: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> options, geom </span>) </span>{
        <span class="hljs-keyword">var</span> buildTree = <span class="hljs-keyword">new</span> BuildKdTree( <span class="hljs-keyword">this</span> );
        <span class="hljs-keyword">return</span> buildTree.build( options, geom );
    },
    intersectRay: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> start, end, intersections, nodePath </span>) </span>{
        <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._kdNodes.length === <span class="hljs-number">0</span> ) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">var</span> numIntersectionsBefore = intersections.length;

        <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>._rayIntersector ) {
            <span class="hljs-keyword">this</span>._rayIntersector = <span class="hljs-keyword">new</span> KdTreeRayIntersector();
            <span class="hljs-keyword">this</span>._rayIntersector.setKdtree( <span class="hljs-keyword">this</span>._vertices, <span class="hljs-keyword">this</span>._kdNodes, <span class="hljs-keyword">this</span>._triangles );
        }
        <span class="hljs-keyword">this</span>._rayIntersector.init( intersections, start, end, nodePath );
        <span class="hljs-keyword">this</span>._rayIntersector.intersect( <span class="hljs-keyword">this</span>.getNodes()[ <span class="hljs-number">0</span> ], start, end );

        <span class="hljs-keyword">return</span> numIntersectionsBefore !== intersections.length;
    },
    intersectSphere: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"> center, radius, intersections, nodePath </span>) </span>{
        <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>._kdNodes.length === <span class="hljs-number">0</span> ) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">var</span> numIntersectionsBefore = intersections.length;

        <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>._sphereIntersector ) {
            <span class="hljs-keyword">this</span>._sphereIntersector = <span class="hljs-keyword">new</span> KdTreeSphereIntersector();
            <span class="hljs-keyword">this</span>._sphereIntersector.setKdtree( <span class="hljs-keyword">this</span>._vertices, <span class="hljs-keyword">this</span>._kdNodes, <span class="hljs-keyword">this</span>._triangles );
        }
        <span class="hljs-keyword">this</span>._sphereIntersector.init( intersections, center, radius, nodePath );
        <span class="hljs-keyword">this</span>._sphereIntersector.intersect( <span class="hljs-keyword">this</span>.getNodes()[ <span class="hljs-number">0</span> ] );

        <span class="hljs-keyword">return</span> numIntersectionsBefore !== intersections.length;
    }
}, <span class="hljs-string">'osg'</span>, <span class="hljs-string">'KdTree'</span> );

<span class="hljs-built_in">module</span>.exports = KdTree;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
